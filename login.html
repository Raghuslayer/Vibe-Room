<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibeRoom - Login / Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
  <style>
    /* Global Styles */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Great+Vibes&family=Poppins:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: url('https://res.cloudinary.com/dpragculd/image/upload/v1748926358/StockCake-Floating_Emoji_Dreams_1748924198_e1beq3.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      perspective: 1000px;
      backdrop-filter: blur(10px);
      flex-direction: column;
      transition: background 0.5s ease, backdrop-filter 0.5s ease;
    }

    /* Remove login background when profile/viberoom is visible */
    body.profile-active {
      background: none;
      backdrop-filter: none;
    }

    /* Styles specific to Login/Sign Up */
    .auth-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 40px;
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      z-index: 1;
      position: relative;
      transition: transform 0.2s ease-out, opacity 0.5s ease-in-out;
      transform-style: preserve-3d;
      max-height: 90vh;
      overflow-y: auto;
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
      /* Hide scrollbar for IE, Edge and Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .auth-container::-webkit-scrollbar {
      display: none;
    }

    @media (max-width: 768px) {
      .auth-container {
        width: 95%;
        padding: 20px;
      }
    }

    .auth-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .auth-header .logo {
      font-size: 48px;
      font-weight: 800;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
      margin-bottom: 10px;
      letter-spacing: 2px;
      animation: pulseGold 2s infinite alternate;
    }

    @keyframes pulseGold {
      0% {
        transform: scale(1);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
      }
      100% {
        transform: scale(1.02);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.9), 0 0 25px rgba(255, 215, 0, 0.7);
      }
    }

    .auth-header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease-in-out;
      overflow: hidden;
    }

    .form-group.hidden-field {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .form-group input,
    .form-group select {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: rgba(138, 43, 226, 0.2);
      backdrop-filter: blur(5px);
      color: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      background: rgba(138, 43, 226, 0.3);
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
    }

    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .auth-btn {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      border: none;
      padding: 12px;
      border-radius: 25px;
      color: white;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .auth-btn:hover {
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
      transform: translateY(-2px);
    }

    .social-login {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .social-btn {
      background: rgba(255, 255, 255, 0.1);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .social-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .social-btn i {
      font-size: 20px;
      color: #fff;
    }

    .toggle-auth {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    .toggle-auth a {
      color: #8A2BE2;
      text-decoration: none;
      font-weight: 500;
    }

    .toggle-auth a:hover {
      text-decoration: underline;
    }

    .error-message {
      color: #FF7B54;
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }

    .custom-modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .custom-modal-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      margin: auto;
      padding: 20px;
      width: 80%;
      max-width: 300px;
      border-radius: 10px;
      text-align: center;
      color: #fff;
    }

    .custom-modal-content h3 {
      margin-bottom: 15px;
      color: #fff;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    .custom-modal-content button {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .custom-modal-content button:hover {
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.6);
      transform: translateY(-1px);
    }

    #loading-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 9999; /* Ensure it's on top */
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: #fff;
      font-size: 3em;
      font-weight: 700;
      letter-spacing: 3px;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.6);
      animation: fadeIn 0.5s ease-out forwards;
    }

    #loading-screen.hidden {
      animation: fadeOut 0.5s ease-out forwards;
    }

    #loading-screen p {
      margin-top: 20px;
      font-size: 0.5em;
      opacity: 0.8;
      animation: pulseText 2s infinite alternate;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes vibingAnimation {
      0% {
        transform: scale(1) translateY(0) skewX(0);
        opacity: 1;
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.6);
      }
      25% {
        transform: scale(1.02) translateY(-2px) skewX(2deg);
        opacity: 0.9;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.7);
      }
      50% {
        transform: scale(1.05) translateY(0) skewX(-2deg);
        opacity: 1;
        text-shadow: 0 0 25px rgba(255, 215, 0, 1), 0 0 35px rgba(255, 215, 0, 0.8);
      }
      75% {
        transform: scale(1.02) translateY(2px) skewX(2deg);
        opacity: 0.9;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.7);
      }
      100% {
        transform: scale(1) translateY(0) skewX(0);
        opacity: 1;
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.6);
      }
    }

    @keyframes pulseText {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    #loading-screen .loading-text {
      font-family: 'Great Vibes', cursive;
      animation: vibingAnimation 2s infinite ease-in-out;
    }

    /* Styles specific to Profile */
    .profile-section {
      background: linear-gradient(135deg, #13111C 0%, #221C3E 100%);
      color: #fff;
      min-height: 100vh;
      display: none;
      flex-direction: column;
      width: 100vw;
      max-width: 100%;
      padding: 0;
      overflow-y: auto;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      z-index: 2;
    }

    .profile-section main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      /* Hide scrollbar for IE, Edge and Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .profile-section main::-webkit-scrollbar {
      display: none;
    }

    .profile-section header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin: 0;
    }

    .profile-section .logo {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #FF7B54, #FFB26B);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(255, 123, 84, 0.3);
    }

    .profile-section .header-actions {
      display: flex;
      align-items: center;
      gap: 15px; /* Use gap for spacing between items */
    }

    .profile-section .notification {
      background: rgba(255, 255, 255, 0.1);
      width: 40px;
      min-width: 40px; /* Ensure minimum width */
      height: 40px;
      min-height: 40px; /* Ensure minimum height */
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .profile-section .notification:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .profile-section .notification::after {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      background: #FF7B54;
      border-radius: 50%;
      top: 5px;
      right: 5px;
    }

    .profile-section .logout-btn {
      background: #FF7B54;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      white-space: nowrap; /* Prevent text wrapping */
    }

    .profile-section .logout-btn:hover {
      box-shadow: 0 0 10px rgba(255, 123, 84, 0.5);
      transform: translateY(-2px);
    }

    @media (min-width: 768px) {
      .profile-section main {
        padding: 20px 40px;
      }
    }

    @media (max-width: 767px) {
      .profile-section main {
        padding: 20px 15px;
      }
    }

    .profile-section .section-heading {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .profile-section .section-heading i {
      color: #FF7B54;
    }

    .profile-section .profile-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .profile-section .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
    }

    .profile-section .profile-header .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid transparent;
      background: linear-gradient(white, white) padding-box,
                 linear-gradient(to right, #FF7B54, #FFB26B) border-box;
      margin-right: 20px;
      flex-shrink: 0; /* Prevent avatar from shrinking */
      position: relative; /* For positioning the upload icon */
    }

    @media (max-width: 480px) {
      .profile-section .profile-header {
        justify-content: center; /* Center align on very small screens */
        text-align: center;
      }
      .profile-section .profile-header .avatar {
        margin-right: 0;
        margin-bottom: 15px;
      }
    }

    .profile-section .profile-header .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-section .avatar-upload-overlay {
      position: absolute;
      bottom: 0;
      right: 0;
      background: rgba(138, 43, 226, 0.8);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .profile-section .avatar-upload-overlay:hover {
      background: rgba(138, 43, 226, 1);
    }

    .profile-section .avatar-upload-overlay input[type="file"] {
      display: none; /* Hide the default file input */
    }

    .profile-section .avatar-upload-overlay i {
      color: #fff;
      font-size: 14px;
    }

    .profile-section .profile-info {
      flex-grow: 1; /* Allow info to take available space */
    }

    .profile-section .profile-info h2 {
      font-size: 24px;
      font-weight: 600;
    }

    .profile-section .profile-info p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .profile-section .profile-info p#profile-status {
      font-weight: 600;
    }

    .profile-section .profile-form label {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
      color: rgba(255, 255, 255, 0.8);
    }

    .profile-section .profile-form input,
    .profile-section .profile-form select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background: rgba(138, 43, 226, 0.2);
      backdrop-filter: blur(5px);
      border: none;
      color: #fff;
      font-size: 14px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .profile-section .profile-form input:focus,
    .profile-section .profile-form select:focus {
      outline: none;
     background: rgba(138, 43, 226, 0.2);
      backdrop-filter: blur(5px);
    }

    .profile-section .profile-form button {
      background: #FF7B54;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
    }

    .profile-section .gradient-card {
      background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
    }

    .profile-section .gradient-card-icon {
      background: rgba(255, 255, 255, 0.2);
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0; /* Prevent icon from shrinking */
    }

    .profile-section .gradient-card-text h3 {
      font-size: 18px;
      margin-bottom: 5px;
    }

    .profile-section .gradient-card-text p {
      font-size: 14px;
      opacity: 0.8;
    }

    .profile-section nav {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin: 0;
    }

    .profile-section .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
      padding: 10px;
      border-radius: 10px;
    }

    .profile-section .nav-item:hover {
      color: #FF7B54;
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .profile-section .nav-item.active {
      color: #FF7B54;
      background: rgba(255, 255, 255, 0.1);
    }

    .profile-section .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -10px;
      width: 30px;
      height: 3px;
      background: linear-gradient(90deg, #FF7B54, #FFB26B);
      border-radius: 2px;
    }

    .profile-section .nav-item i {
      font-size: 24px;
      transition: all 0.3s ease;
    }

    .profile-section .nav-item.active i {
      text-shadow: 0 0 10px rgba(255, 123, 84, 0.5);
    }

    .profile-section .nav-item span {
      font-size: 12px;
      font-weight: 500;
    }

    /* Utility classes for showing/hiding sections */
    .hidden {
      display: none !important;
      opacity: 0;
    }
    .visible {
      display: flex !important;
      opacity: 1;
    }

    /* Styles for the cropping modal */
    .crop-modal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 200; /* Higher than other modals */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8); /* Darker overlay */
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .crop-modal-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      text-align: center;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .crop-modal-content img {
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }

    .crop-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .crop-buttons button {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .crop-buttons button:hover {
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.6);
      transform: translateY(-1px);
    }

    .crop-buttons button.cancel-crop {
      background: #FF7B54;
    }
    .crop-buttons button.cancel-crop:hover {
      box-shadow: 0 0 10px rgba(255, 123, 84, 0.6);
    }

    /* VibeRoom Specific Styles */
    .viberoom-section {
      background: linear-gradient(135deg, #13111C 0%, #221C3E 100%);
      color: #fff;
      min-height: 100vh;
      display: none; /* Hidden by default */
      flex-direction: column;
      width: 100vw;
      max-width: 100%;
      padding: 0;
      overflow-y: auto;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      z-index: 2;
    }

    .viberoom-section main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .viberoom-section main::-webkit-scrollbar {
      display: none;
    }

    .viberoom-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .viberoom-option-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(5px);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 150px;
    }

    .viberoom-option-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .viberoom-option-card i {
      font-size: 40px;
      margin-bottom: 15px;
      color: #FF7B54;
    }

    .viberoom-option-card h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .viberoom-option-card p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Private Room Modal */
    .private-room-modal {
      display: none;
      position: fixed;
      z-index: 300;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
    }

    .private-room-modal-content {
      background: linear-gradient(135deg, #13111C 0%, #221C3E 100%);
      border-radius: 15px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      color: #fff;
      text-align: center;
      position: relative; /* For close button positioning */
    }

    .private-room-modal-content h3 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #FF7B54;
    }

    .private-room-modal-content .form-group {
      margin-bottom: 20px;
    }

    .private-room-modal-content label {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .private-room-modal-content input,
    .private-room-modal-content select {
      width: calc(100% - 40px); /* Adjust for padding */
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: rgba(138, 43, 226, 0.2);
      color: #fff;
      font-size: 16px;
    }

    .private-room-modal-content input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .private-room-modal-content button {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      color: white;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .private-room-modal-content button:hover {
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
      transform: translateY(-2px);
    }

    .private-room-modal-content .close-button {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .private-room-modal-content .close-button:hover {
      color: #FF7B54;
    }

    /* Room Details Display */
    .room-details-display {
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        text-align: left;
    }
    .room-details-display p {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
    }
    .room-details-display span {
        font-weight: 600;
        color: #FFB26B;
    }
    .room-details-display button.copy-button {
        background: none;
        border: none;
        color: #FFB26B;
        font-size: 14px;
        cursor: pointer;
        margin-left: 5px;
        padding: 5px;
        border-radius: 5px;
        transition: background 0.2s ease;
    }
    .room-details-display button.copy-button:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    .room-details-display button#start-private-room {
        margin-top: 10px;
        background: #FF7B54;
    }

    /* Video Call Room Styles */
    .video-call-room {
      display: none; /* Hidden by default */
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      overflow: hidden; /* Changed: main overflow handled by body on mobile, grid handles desktop */
      background: #13111C;
      position: relative;
      border: 5px solid transparent; /* For RGB glowing line */
      animation: none; /* Controlled by JS */
    }

    @keyframes glowing-border {
      0% { border-color: #ff0000; }
      16% { border-color: #ffff00; }
      33% { border-color: #00ff00; }
      50% { border-color: #00ffff; }
      66% { border-color: #0000ff; }
      83% { border-color: #ff00ff; }
      100% { border-color: #ff0000; }
    }

    .video-call-room.music-active {
      animation: glowing-border 6s infinite linear;
    }


    .video-call-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .video-call-header h2 {
      font-size: 20px;
      color: #FFB26B;
    }

    .video-call-header .room-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .video-call-header .room-actions button {
      background: #FF7B54;
      border: none;
      padding: 8px 15px;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .video-call-header .room-actions button:hover {
      background: #e66a4a;
      transform: translateY(-1px);
    }

    .video-call-main-content {
      flex: 1;
      display: grid; /* Use grid for 2x2 layout on desktop */
      grid-template-columns: 1fr 1fr; /* Two columns */
      grid-template-rows: 3fr 1fr; /* Changed: Top row (video/chat) gets 3x space, bottom row (music/pomodoro) gets 1x */
      gap: 10px; /* Gap between grid items */
      padding: 10px; /* Padding around the grid */
      overflow: hidden; /* Prevent overall scrolling, individual sections will scroll */
    }

    .video-feeds-section {
      grid-area: 1 / 1 / 2 / 2; /* Top-left quadrant */
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Dynamic columns for feeds */
      gap: 10px;
      padding: 10px;
      background: #221C3E;
      overflow-y: auto; /* Enable scrolling for video feeds */
      -ms-overflow-style: none;
      scrollbar-width: none;
      border-radius: 10px;
    }
    .video-feeds-section::-webkit-scrollbar {
      display: none;
    }

    .video-feed-container {
      position: relative;
      width: 100%;
      padding-bottom: 75%; /* 4:3 aspect ratio for video, adjust as needed */
      background-color: #000;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .video-feed-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
    }

    .video-feed-controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      padding: 5px 10px;
      display: flex;
      gap: 10px;
      z-index: 5;
    }

    .video-feed-controls button {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .video-feed-controls button:hover {
      color: #FF7B54;
    }

    .video-feed-controls button.active {
      color: #8BC34A; /* Green for active */
    }
    .video-feed-controls button.inactive {
      color: #FF7B54; /* Red for inactive */
    }


    .gemini-chat-box {
      grid-area: 1 / 2 / 2 / 3; /* Top-right quadrant */
      display: flex;
      flex-direction: column;
      padding: 15px;
      background: #1A162A; /* Match right panel background */
      border-radius: 10px;
      overflow: hidden; /* Ensure chat messages scroll within */
    }

    .gemini-chat-box h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #8B5CF6;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px; /* For scrollbar space */
      -ms-overflow-style: none;
      scrollbar-width: none;
      display: flex;
      flex-direction: column; /* Ensure messages stack vertically */
    }
    .chat-messages::-webkit-scrollbar {
      display: none;
    }

    .chat-message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word; /* Ensure long words break */
    }

    .chat-message.user {
      background: rgba(138, 43, 226, 0.3);
      align-self: flex-end;
      margin-left: auto;
    }

    .chat-message.gemini {
      background: rgba(255, 255, 255, 0.1);
      align-self: flex-start;
      margin-right: auto;
    }
    .chat-message.gemini p {
        margin: 0;
    }

    .chat-input-container {
      display: flex;
      margin-top: 10px;
    }

    .chat-input-container input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 20px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
    }

    .chat-input-container button {
      background: #8B5CF6;
      border: none;
      padding: 10px 15px;
      border-radius: 20px;
      margin-left: 10px;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .chat-input-container button:hover {
      background: #7a4be0;
    }

    .music-player-section {
      grid-area: 2 / 1 / 3 / 2; /* Bottom-left quadrant */
      display: flex;
      flex-direction: column;
      padding: 15px;
      background: #1A162A; /* Match right panel background */
      border-radius: 10px;
      overflow: hidden;
    }

    .music-player-section h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #FFB26B;
    }

    .music-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }

    .music-controls button {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .music-controls button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .music-player-section input[type="range"] {
        width: 80%;
        margin: 10px auto;
        -webkit-appearance: none;
        height: 8px;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.2);
        outline: none;
        transition: opacity .2s;
    }

    .music-player-section input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #FF7B54;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(255, 123, 84, 0.5);
    }

    .pomodoro-section {
      grid-area: 2 / 2 / 3 / 3; /* Bottom-right quadrant */
      display: flex;
      flex-direction: column;
      padding: 15px;
      background: #1A162A; /* Match right panel background */
      border-radius: 10px;
      overflow: hidden;
    }

    .pomodoro-section h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #6366F1;
    }

    .pomodoro-timer {
      font-size: 48px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 15px;
    }

    .pomodoro-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .pomodoro-controls button {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      padding: 8px 15px;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .pomodoro-controls button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .pomodoro-time-select {
      display: flex;
      justify-content: center;
      flex-wrap: wrap; /* Allow buttons to wrap */
      gap: 10px;
      margin-bottom: 15px;
    }

    .pomodoro-time-select button {
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.5);
      padding: 8px 12px;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pomodoro-time-select button.active,
    .pomodoro-time-select button:hover {
      background: rgba(138, 43, 226, 0.5);
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
    }

    /* Mobile responsiveness for video call room */
    @media (max-width: 768px) {
      .video-call-room {
        overflow-y: auto; /* Changed: Allow scrolling on mobile */
      }
      .video-call-main-content {
        display: flex; /* Revert to flex for stacking on mobile */
        flex-direction: column;
        gap: 0; /* Remove gap for stacked layout */
        padding: 0; /* Remove padding for full width */
      }
      .video-feeds-section {
        flex: none;
        width: 100%;
        height: auto;
        max-height: 50vh; /* Limit height to prevent excessive scrolling */
        border-radius: 0; /* Remove border-radius on mobile for full width */
        padding: 10px; /* Add back padding for content */
      }
      .gemini-chat-box, .music-player-section, .pomodoro-section {
        flex: none; /* Allow content to dictate height */
        width: 100%;
        height: auto;
        min-height: 200px; /* Ensure some visibility */
        border-radius: 0; /* Remove border-radius on mobile for full width */
        border-left: none; /* Remove left border */
        border-top: 1px solid rgba(255, 255, 255, 0.1); /* Add top border for separation */
      }
    }

    /* Loading dots for Gemini chat */
    .loading-dots {
      display: inline-block;
      width: auto; /* Adjust width as needed */
      text-align: left;
    }

    .loading-dots span {
      opacity: 0;
      animation: blink 1.4s infinite;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="auth-container" id="auth-container">
    <div class="auth-header">
      <div class="logo">VibeRoom</div>
      <p id="auth-subtitle">Sign up to join the vibe!</p>
    </div>
    <form class="auth-form" id="auth-form">
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="e.g., @raghu_07">
      </div>
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" placeholder="Enter your name">
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Enter email">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter password">
      </div>
      <div class="form-group" id="dob-group">
        <label for="dob">Date of Birth</label>
        <input type="date" id="dob">
      </div>
      <div class="form-group" id="gender-group">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="">Select Gender</option>
        </select>
      </div>
      <div class="form-group" id="country-group">
        <label for="country">Country</label>
        <select id="country">
          <option value="">Select Country</option>
        </select>
      </div>
      <div class="form-group" id="language-group">
        <label for="language">Preferred Language</label>
        <select id="language">
          <option value="">Select Language</option>
        </select>
      </div>
      <button type="submit" class="auth-btn" id="auth-btn">Sign Up</button>
      <div class="error-message" id="error-message"></div>
    </form>
    <div class="social-login">
      <div class="social-btn" id="google-login">
        <i class="fab fa-google"></i>
      </div>
      <div class="social-btn" id="apple-login">
        <i class="fab fa-apple"></i>
      </div>
    </div>
    <div class="toggle-auth">
      Already have an account? <a href="#" id="toggle-link">Log In</a>
    </div>
  </div>

  <div class="profile-section hidden" id="profile-section">
    <header>
      <div class="logo">VibeRoom</div>
      <div class="header-actions">
        <div class="notification">
          <i class="fas fa-bell"></i>
        </div>
        <button class="logout-btn" id="logout-btn">Logout</button>
      </div>
    </header>

    <main>
      <div class="gradient-card">
        <div class="gradient-card-icon">
          <i class="fas fa-user"></i>
        </div>
        <div class="gradient-card-text">
          <h3>Your Profile</h3>
          <p>Manage your personal information</p>
        </div>
      </div>

      <section class="profile">
        <div class="section-heading">
          <i class="fas fa-user"></i> Profile
        </div>
        <div class="profile-card">
          <div class="profile-header">
            <div class="avatar">
              <img src="https://placehold.co/100x100/A239CA/FFFFFF?text=P" alt="Profile Picture" id="profile-img">
              <label for="profile-image-upload" class="avatar-upload-overlay">
                <i class="fas fa-camera"></i>
                <input type="file" id="profile-image-upload" accept="image/*">
              </label>
            </div>
            <div class="profile-info">
              <h2 id="profile-username">@Username</h2>
              <p id="profile-name">User Name</p>
              <p id="profile-email">No Email</p>
              <p id="profile-dob">No DOB</p>
              <p id="profile-gender">No Gender</p>
              <p id="profile-country">No Country</p>
              <p id="profile-language">No Language</p>
              <p id="profile-status">Offline</p>
            </div>
          </div>
          <div class="profile-form">
            <label for="profile-username-input">Username</label>
            <input type="text" id="profile-username-input" placeholder="Enter your username">
            <label for="profile-name-input">Name</label>
            <input type="text" id="profile-name-input" placeholder="Enter your name">
            <label for="profile-dob-input">Date of Birth</label>
            <input type="date" id="profile-dob-input">
            <label for="profile-gender-select">Gender</label>
            <select id="profile-gender-select">
              <option value="">Select Gender</option>
            </select>
            <label for="profile-country-select">Country</label>
            <select id="profile-country-select">
              <option value="">Select Country</option>
            </select>
            <label for="profile-language-select">Preferred Language</label>
            <select id="profile-language-select">
              <option value="">Select Language</option>
            </select>
            <button id="save-profile">Save Changes</button>
          </div>
        </div>
      </section>
    </main>

    <nav>
      <a href="#" class="nav-item" id="nav-home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="#" class="nav-item" id="nav-viberoom-main-nav">
        <i class="fas fa-music"></i>
        <span>VibeRoom</span>
      </a>
      <a href="#" class="nav-item" id="nav-buddies">
        <i class="fas fa-user-group"></i>
        <span>Buddies</span>
      </a>
      <a href="#" class="nav-item active" id="nav-profile">
        <i class="fas fa-user"></i>
        <span>Profile</span>
      </a>
    </nav>
  </div>

  <div class="viberoom-section hidden" id="viberoom-section">
    <header>
      <div class="logo">VibeRoom</div>
      <div class="header-actions">
        <div class="notification">
          <i class="fas fa-bell"></i>
        </div>
        <!-- Removed logout button from VibeRoom header as requested -->
      </div>
    </header>

    <main>
      <div class="gradient-card">
        <div class="gradient-card-icon">
          <i class="fas fa-video"></i>
        </div>
        <div class="gradient-card-text">
          <h3>Welcome to VibeRoom!</h3>
          <p>Connect with others through video calls and shared vibes.</p>
        </div>
      </div>

      <section class="viberoom-options">
        <div class="viberoom-option-card" id="private-room-option">
          <i class="fas fa-lock"></i>
          <h3>Private Room</h3>
          <p>Create a private room or join with ID/Password</p>
        </div>
        <div class="viberoom-option-card" id="selective-room-option">
          <i class="fas fa-users-medical"></i>
          <h3>Selective Room</h3>
          <p>Choose who to vibe with (Coming Soon)</p>
        </div>
        <div class="viberoom-option-card" id="random-room-option">
          <i class="fas fa-shuffle"></i>
          <h3>Random Room</h3>
          <p>Join a random room (Coming Soon)</p>
        </div>
        <div class="viberoom-option-card" id="join-room-option">
          <i class="fas fa-door-open"></i>
          <h3>Join Room</h3>
          <p>Enter an existing room with ID and Password</p>
        </div>
      </section>
    </main>

    <nav>
      <a href="#" class="nav-item" id="nav-viberoom-home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="#" class="nav-item active" id="nav-viberoom-main">
        <i class="fas fa-music"></i>
        <span>VibeRoom</span>
      </a>
      <a href="#" class="nav-item" id="nav-viberoom-buddies">
        <i class="fas fa-user-group"></i>
        <span>Buddies</span>
      </a>
      <a href="#" class="nav-item" id="nav-viberoom-profile">
        <i class="fas fa-user"></i>
        <span>Profile</span>
      </a>
    </nav>
  </div>

  <div id="privateRoomModal" class="private-room-modal">
    <div class="private-room-modal-content">
      <button class="close-button" id="closePrivateRoomModal">&times;</button>
      <h3 id="privateRoomModalTitle">Create Private Room</h3>
      <div class="form-group">
        <label for="room-max-persons">Maximum Persons</label>
        <select id="room-max-persons">
          <option value="2">2 Persons</option>
          <option value="3">3 Persons</option>
          <option value="4">4 Persons</option>
        </select>
      </div>
      <div class="form-group">
        <label for="room-category">Category</label>
        <select id="room-category">
          <option value="study">Study</option>
          <option value="music">Music (Coming Soon)</option>
          <option value="gym">Gym (Coming Soon)</option>
          <option value="random">Random (Coming Soon)</option>
        </select>
      </div>
      <div class="form-group hidden" id="join-room-inputs">
        <label for="join-room-id">Room ID</label>
        <input type="text" id="join-room-id" placeholder="Enter Room ID">
        <label for="join-room-password">Room Password</label>
        <input type="password" id="join-room-password" placeholder="Enter Room Password">
      </div>
      <button id="privateRoomActionButton">Create Room</button>
      <div class="room-details-display hidden" id="created-room-details">
          <p>Room ID: <span id="display-room-id"></span> <button class="copy-button" data-target="display-room-id"><i class="fas fa-copy"></i></button></p>
          <p>Password: <span id="display-room-password"></span> <button class="copy-button" data-target="display-room-password"><i class="fas fa-copy"></i></button></p>
          <button id="start-private-room">Start Room</button>
      </div>
    </div>
  </div>

  <div class="video-call-room hidden" id="video-call-room">
    <header class="video-call-header">
      <h2 id="current-room-name">VibeRoom Call</h2>
      <div class="room-actions">
        <button id="end-room-btn" class="hidden">End Room</button>
        <button id="exit-room-btn">Exit Room</button>
      </div>
    </header>
    <div class="video-call-main-content">
      <!-- Video Feeds Section (Top Left) -->
      <div class="video-feeds-section" id="video-feeds-section">
        <div class="video-feed-container" id="local-video-container">
          <video id="local-video" autoplay muted></video>
          <div class="video-feed-controls">
            <button id="local-cam-toggle"><i class="fas fa-video"></i></button>
            <button id="local-mic-toggle"><i class="fas fa-microphone"></i></button>
          </div>
        </div>
        <!-- Remote video feeds will be added here dynamically -->
      </div>

      <!-- Gemini Chat Box (Top Right) -->
      <div class="gemini-chat-box">
          <h3>Gemini Chat</h3>
          <div class="chat-messages" id="gemini-chat-messages">
            </div>
          <div class="chat-input-container">
            <input type="text" id="gemini-chat-input" placeholder="Ask Gemini...">
            <button id="send-gemini-chat"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>

      <!-- Music Player Section (Bottom Left) -->
      <div class="music-player-section">
          <h3>Music Player</h3>
          <p id="current-song-title">No song playing</p>
          <input type="range" id="music-volume-slider" min="0" max="1" step="0.01" value="0.5">
          <div class="music-controls">
            <button id="music-prev"><i class="fas fa-backward"></i></button>
            <button id="music-play-pause"><i class="fas fa-play"></i></button>
            <button id="music-next"><i class="fas fa-forward"></i></button>
          </div>
        </div>

      <!-- Pomodoro Timer Section (Bottom Right) -->
      <div class="pomodoro-section">
          <h3>Pomodoro Timer</h3>
          <div class="pomodoro-time-select">
            <button data-time="25">25 min</button>
            <button data-time="45">45 min</button>
            <button data-time="60">1 hr</button>
            <button data-time="90">1.5 hr</button>
          </div>
          <div class="pomodoro-timer" id="pomodoro-timer-display">25:00</div>
          <div class="pomodoro-controls">
            <button id="pomodoro-start-pause"><span id="pomodoro-start-pause-text">Start</span> <i class="fas fa-play"></i></button>
            <button id="pomodoro-reset"><i class="fas fa-redo"></i></button>
          </div>
        </div>
    </div>
  </div>


  <div id="customAlertModal" class="custom-modal">
    <div class="custom-modal-content">
      <h3 id="modalMessage"></h3>
      <button id="modalCloseButton">OK</button>
    </div>
  </div>

  <div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
      <h3>Crop your profile picture</h3>
      <div>
        <img id="imageToCrop" src="" alt="Image to Crop">
      </div>
      <div class="crop-buttons">
        <button id="cropAndUploadButton">Crop & Upload</button>
        <button class="cancel-crop" id="cancelCropButton">Cancel</button>
      </div>
    </div>
  </div>

  <div id="loading-screen">
    <div class="loading-text">Vibing...</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      updateProfile,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';
    import { getDatabase, ref, set, onDisconnect, serverTimestamp, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js';
    import { signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';


    // Firebase configuration
    // Use the global __firebase_config variable if available, otherwise use a default
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyC1Si1eckeNa-aF2RtQzIDckDhbvZlI66A",
      authDomain: "viberoom-3af1f.firebaseapp.com",
      projectId: "viberoom-3af1f",
      storageBucket: "viberoom-3af1f.firebasestorage.app",
      messagingSenderId: "84466588442",
      appId: "1:84466588442:web:b2100ca39f2b25dba36aa3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // Get the app ID from the environment or use a default
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-viberoom-app';

    // Function to get user profile document reference
    function getUserProfileDocRef(uid) {
        // Corrected path to ensure even number of segments for a document reference.
        // It now points to a document named 'data' within the 'profile' sub-collection
        // under the user's UID.
        return doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
    }

    // Function to get room document reference
    function getRoomDocRef(roomId) {
        return doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
    }

    // Get elements for login/signup
    const authContainer = document.getElementById('auth-container');
    const form = document.getElementById('auth-form');
    const authBtn = document.getElementById('auth-btn');
    const authSubtitle = document.getElementById('auth-subtitle');
    const toggleLink = document.getElementById('toggle-link');
    const dobGroup = document.getElementById('dob-group');
    const genderGroup = document.getElementById('gender-group');
    const countryGroup = document.getElementById('country-group');
    const languageGroup = document.getElementById('language-group');
    const errorMessage = document.getElementById('error-message');
    const loadingScreen = document.getElementById('loading-screen');
    let isSignup = true;

    // Get elements for profile
    const profileSection = document.getElementById('profile-section');
    const profileUsernameDisplay = document.getElementById('profile-username');
    const profileNameDisplay = document.getElementById('profile-name');
    const profileEmailDisplay = document.getElementById('profile-email');
    const profileDobDisplay = document.getElementById('profile-dob');
    const profileGenderDisplay = document.getElementById('profile-gender');
    const profileCountryDisplay = document.getElementById('profile-country');
    const profileLanguageDisplay = document.getElementById('profile-language');
    const profileStatusDisplay = document.getElementById('profile-status');
    const profileUsernameInput = document.getElementById('profile-username-input');
    const profileNameInput = document.getElementById('profile-name-input');
    const profileDobInput = document.getElementById('profile-dob-input');
    const profileGenderSelect = document.getElementById('profile-gender-select');
    const profileCountrySelect = document.getElementById('profile-country-select');
    const profileLanguageSelect = document.getElementById('profile-language-select');
    const saveProfileButton = document.getElementById('save-profile');
    const logoutButton = document.getElementById('logout-btn');
    const profileImg = document.getElementById('profile-img');
    const profileImageUpload = document.getElementById('profile-image-upload');
    const navVibeRoomMainNav = document.getElementById('nav-viberoom-main-nav');

    // Custom Alert Modal elements
    const customAlertModal = document.getElementById('customAlertModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalCloseButton = document.getElementById('modalCloseButton');

    // Cropping Modal elements
    const cropModal = document.getElementById('cropModal');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropAndUploadButton = document.getElementById('cropAndUploadButton');
    const cancelCropButton = document.getElementById('cancelCropButton');
    let cropper;
    let selectedProfileImageFile = null;

    // VibeRoom Main elements
    const viberoomSection = document.getElementById('viberoom-section');
    const privateRoomOption = document.getElementById('private-room-option');
    const selectiveRoomOption = document.getElementById('selective-room-option');
    const randomRoomOption = document.getElementById('random-room-option');
    const joinRoomOption = document.getElementById('join-room-option');
    const navVibeRoomHome = document.getElementById('nav-viberoom-home');
    const navVibeRoomMain = document.getElementById('nav-viberoom-main');
    const navVibeRoomBuddies = document.getElementById('nav-viberoom-buddies');
    const navVibeRoomProfile = document.getElementById('nav-viberoom-profile');

    // Private Room Modal elements
    const privateRoomModal = document.getElementById('privateRoomModal');
    const closePrivateRoomModal = document.getElementById('closePrivateRoomModal');
    const privateRoomModalTitle = document.getElementById('privateRoomModalTitle');
    const roomMaxPersonsSelect = document.getElementById('room-max-persons');
    const roomCategorySelect = document.getElementById('room-category');
    const privateRoomActionButton = document.getElementById('privateRoomActionButton');
    const joinRoomInputs = document.getElementById('join-room-inputs');
    const joinRoomIdInput = document.getElementById('join-room-id');
    const joinRoomPasswordInput = document.getElementById('join-room-password');
    const createdRoomDetails = document.getElementById('created-room-details');
    const displayRoomId = document.getElementById('display-room-id');
    const displayRoomPassword = document.getElementById('display-room-password');
    const startPrivateRoomButton = document.getElementById('start-private-room');
    const copyButtons = document.querySelectorAll('.copy-button');

    // Video Call Room elements
    const videoCallRoom = document.getElementById('video-call-room');
    const currentRoomName = document.getElementById('current-room-name');
    const endRoomBtn = document.getElementById('end-room-btn');
    const exitRoomBtn = document.getElementById('exit-room-btn');
    const videoFeedsSection = document.getElementById('video-feeds-section');
    const localVideo = document.getElementById('local-video');
    const localCamToggle = document.getElementById('local-cam-toggle');
    const localMicToggle = document.getElementById('local-mic-toggle');
    const localVideoContainer = document.getElementById('local-video-container');


    // Gemini Chat elements
    const geminiChatMessages = document.getElementById('gemini-chat-messages');
    const geminiChatInput = document.getElementById('gemini-chat-input');
    const sendGeminiChatButton = document.getElementById('send-gemini-chat');
    let chatHistory = []; // For Gemini API

    // Music Player elements
    const musicVolumeSlider = document.getElementById('music-volume-slider');
    const musicPlayPauseButton = document.getElementById('music-play-pause');
    const musicPrevButton = document.getElementById('music-prev');
    const musicNextButton = document.getElementById('music-next');
    const currentSongTitle = document.getElementById('current-song-title');
    let currentAudio = new Audio();
    let musicPlaying = false;
    let currentSongIndex = 0;
    const musicPlaylist = [
      { title: "Chill Study Beats", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
      { title: "Relaxing Piano", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
      { title: "Ambient Background", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }
    ];

    // Pomodoro Timer elements
    const pomodoroTimerDisplay = document.getElementById('pomodoro-timer-display');
    const pomodoroTimeSelectButtons = document.querySelectorAll('.pomodoro-time-select button');
    const pomodoroStartPauseButton = document.getElementById('pomodoro-start-pause');
    const pomodoroStartPauseText = document.getElementById('pomodoro-start-pause-text'); // New element for text
    const pomodoroResetButton = document.getElementById('pomodoro-reset');
    let pomodoroInterval;
    let pomodoroTimeLeft = 25 * 60; // Default to 25 minutes in seconds
    let pomodoroRunning = false;

    // WebRTC/PeerJS variables
    let peer = null;
    let localStream = null;
    const connectedPeers = {}; // Stores PeerJS connections: {peerId: {call: MediaConnection, stream: MediaStream, videoElement: HTMLVideoElement, controls: HTMLDivElement}}
    let currentRoomId = null;
    let isRoomCreator = false;
    let roomParticipantsListener = null; // To store onSnapshot listener for room participants
    let roomStatusListener = null; // To store onSnapshot listener for room status
    let userInRoom = false; // Flag to track if user is in a room

    // PeerJS Reconnection variables
    const MAX_RECONNECT_ATTEMPTS = 5;
    let currentReconnectAttempt = 0;
    let reconnectTimeoutId = null;


    // ImgBB API Key
    const IMGBB_API_KEY = 'ed2da0de64a3e62a7c622a3edbae9419';

    // Data for dropdowns
    const genders = ['Male', 'Female', 'Other', 'Prefer not to say'];
    const countries = [
      "United States", "Canada", "United Kingdom", "Australia", "India", "Germany", "France", "Japan", "China", "Brazil",
      "Mexico", "South Africa", "Egypt", "Nigeria", "Argentina", "Spain", "Italy", "Netherlands", "Sweden", "Norway",
      "Denmark", "Finland", "Switzerland", "Austria", "Belgium", "Portugal", "Greece", "Ireland", "New Zealand",
      "Singapore", "South Korea", "Thailand", "Indonesia", "Malaysia", "Philippines", "Vietnam", "Saudi Arabia",
      "United Arab Emirates", "Turkey", "Russia", "Poland", "Ukraine", "Colombia", "Chile", "Peru", "Venezuela",
      "Pakistan", "Bangladesh", "Sri Lanka", "Kenya", "Morocco", "Algeria", "Ethiopia", "Ghana", "Uganda", "Tanzania"
    ];
    const languages = [
      "English", "Spanish", "French", "German", "Mandarin Chinese", "Hindi", "Bengali", "Portuguese", "Russian", "Japanese",
      "Korean", "Arabic", "Punjabi", "Urdu", "Telugu", "Tamil", "Marathi", "Vietnamese", "Italian", "Turkish",
      "Thai", "Gujarati", "Polish", "Ukrainian", "Romanian", "Dutch", "Swedish", "Greek", "Czech", "Norwegian",
      "Danish", "Finnish", "Hebrew", "Indonesian", "Malay", "Filipino", "Swahili", "Amharic", "Yoruba", "Igbo"
    ];

    /**
     * Populates a select element with options from an array.
     * @param {HTMLSelectElement} selectElement - The select element to populate.
     * @param {string[]} dataArray - An array of strings for the options.
     * @param {string} selectedValue - The value to mark as selected.
     */
    function populateSelect(selectElement, dataArray, selectedValue) {
      const initialOption = selectElement.querySelector('option[value=""]');
      selectElement.innerHTML = '';
      if (initialOption) {
        selectElement.appendChild(initialOption);
      } else {
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Select...";
        selectElement.appendChild(defaultOption);
      }

      dataArray.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        if (item === selectedValue) {
          option.selected = true;
        }
        selectElement.appendChild(option);
      });
    }

    // Populate dropdowns on initial load
    document.addEventListener('DOMContentLoaded', () => {
      populateSelect(document.getElementById('gender'), genders, '');
      populateSelect(document.getElementById('country'), countries, '');
      populateSelect(document.getElementById('language'), languages, '');
      populateSelect(profileGenderSelect, genders, '');
      populateSelect(profileCountrySelect, countries, '');
      populateSelect(profileLanguageSelect, languages, '');
    });

    /**
     * Displays a custom alert modal with a given message.
     * @param {string} message - The message to display in the modal.
     * @returns {Promise<void>} A promise that resolves when the user closes the alert.
     */
    function showCustomAlert(message) {
      return new Promise((resolve) => {
        modalMessage.textContent = message;
        customAlertModal.style.display = 'flex';
        const closeHandler = () => {
          customAlertModal.style.display = 'none';
          modalCloseButton.removeEventListener('click', closeHandler);
          resolve();
        };
        modalCloseButton.addEventListener('click', closeHandler);
      });
    }

    /**
     * Displays an error message below the form.
     * @param {string} message - The error message to display.
     */
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 3000);
    }

    /**
     * Toggles between signup and login forms.
     */
    function toggleAuthMode() {
      isSignup = !isSignup;
      authSubtitle.textContent = isSignup ? 'Sign up to join the vibe!' : 'Log in to your account';
      authBtn.textContent = isSignup ? 'Sign Up' : 'Log In';
      toggleLink.textContent = isSignup ? 'Log In' : 'Sign Up';

      dobGroup.classList.toggle('hidden-field', !isSignup);
      genderGroup.classList.toggle('hidden-field', !isSignup);
      countryGroup.classList.toggle('hidden-field', !isSignup);
      languageGroup.classList.toggle('hidden-field', !isSignup);
      document.getElementById('name').parentElement.classList.toggle('hidden-field', !isSignup);

      document.getElementById('username').value = '';
      document.getElementById('name').value = '';
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      document.getElementById('dob').value = '';
      document.getElementById('gender').value = '';
      document.getElementById('country').value = '';
      document.getElementById('language').value = '';

      errorMessage.style.display = 'none';
    }

    // Event listener for toggling between login/signup
    toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      toggleAuthMode();
    });

    // Initial state setup
    document.addEventListener('DOMContentLoaded', () => {
      if (!isSignup) {
        dobGroup.classList.add('hidden-field');
        genderGroup.classList.add('hidden-field');
        countryGroup.classList.add('hidden-field');
        languageGroup.classList.add('hidden-field');
        document.getElementById('name').parentElement.classList.add('hidden-field');
      }
    });

    /**
     * Shows the loading screen.
     */
    function showLoadingScreen() {
      loadingScreen.style.display = 'flex';
      loadingScreen.classList.remove('hidden');
    }

    /**
     * Hides the loading screen.
     */
    function hideLoadingScreen() {
      loadingScreen.classList.add('hidden');
      loadingScreen.addEventListener('animationend', () => {
        loadingScreen.style.display = 'none';
      }, { once: true });
    }

    /**
     * Handles form submission for both signup and login.
     */
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!email) {
        showError('Please enter your email.');
        return;
      }
      if (!password) {
        showError('Please enter your password.');
        return;
      }

      try {
        if (isSignup) {
          const dob = document.getElementById('dob').value;
          const gender = document.getElementById('gender').value;
          const country = document.getElementById('country').value;
          const language = document.getElementById('language').value;

          if (!username.startsWith('@') || username.length < 4) {
            showError('Username must start with @ and be at least 4 characters');
            return;
          }
          if (!name) {
            showError('Please enter your name.');
            return;
          }
          if (!dob) {
            showError('Please enter your date of birth.');
            return;
          }
          if (!gender) {
            showError('Please select your gender.');
            return;
          }
          if (!country) {
            showError('Please select your country.');
            return;
          }
          if (!language) {
            showError('Please select your preferred language.');
            return;
          }

          const dobDate = new Date(dob);
          const today = new Date();
          let age = today.getFullYear() - dobDate.getFullYear();
          const monthDiff = today.getMonth() - dobDate.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dobDate.getDate())) {
            age--;
          }
          if (age < 13) {
            showError('You must be at least 13 years old to sign up');
            return;
          }

          showLoadingScreen();
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          await updateProfile(user, { displayName: username });

          // Store user profile data in Firestore. The path is now:
          // artifacts/{appId}/users/{uid}/profile/data
          await setDoc(getUserProfileDocRef(user.uid), {
            username,
            name,
            email,
            dob,
            gender,
            country,
            language,
            status: 'Offline', // Will be set to Online by setUserOnlineStatus on next auth state change
            profileImage: '' // Initialize with empty string
          });

          setTimeout(() => {
            hideLoadingScreen();
            showCustomAlert('Signed up successfully!');
          }, 2000);

        } else {
          showLoadingScreen();
          await signInWithEmailAndPassword(auth, email, password);

          setTimeout(() => {
            hideLoadingScreen();
            showCustomAlert('Logged in successfully!');
          }, 2000);
        }
      } catch (error) {
        hideLoadingScreen();
        switch (error.code) {
          case 'auth/email-already-in-use':
            showError('Email already in use');
            break;
          case 'auth/invalid-email':
            showError('Invalid email format');
            break;
          case 'auth/weak-password':
            showError('Password must be at least 6 characters');
            break;
          case 'auth/user-not-found':
          case 'auth/wrong-password':
            showError('Invalid email or password');
            break;
          default:
            showError('An error occurred: ' + error.message);
        }
      }
    });

    // Google Login
    document.getElementById('google-login').addEventListener('click', async () => {
      try {
        showLoadingScreen();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        const userDocRef = getUserProfileDocRef(user.uid); // Changed
        const userDoc = await getDoc(userDocRef);
        if (!userDoc.exists()) {
          const userData = {
            username: user.displayName || '@' + user.email.split('@')[0],
            name: user.displayName || 'User',
            email: user.email,
            dob: '',
            gender: 'Prefer not to say',
            country: 'United States',
            language: 'English',
            status: 'Offline', // Will be set to Online by setUserOnlineStatus on next auth state change
            profileImage: user.photoURL || '' // Use Google profile photo if available
          };
          // Store user profile data in Firestore. The path is now:
          // artifacts/{appId}/users/{uid}/profile/data
          await setDoc(getUserProfileDocRef(user.uid), userData);
        } else {
          // If user exists, update their profile image if it's a Google photo and not already set
          if (user.photoURL && !userDoc.data().profileImage) {
            // Update user profile data in Firestore. The path is now:
            // artifacts/{appId}/users/{uid}/profile/data
            await updateDoc(getUserProfileDocRef(user.uid), { profileImage: user.photoURL });
          }
        }

        setTimeout(() => {
          hideLoadingScreen();
          showCustomAlert('Logged in with Google successfully!');
        }, 2000);

      } catch (error) {
        hideLoadingScreen();
        showError('Google login failed: ' + error.message);
      }
    });

    // Apple Login (Not implemented)
    document.getElementById('apple-login').addEventListener('click', () => {
      showCustomAlert('Apple login not implemented yet');
    });

    // Removed mousemove parallax effect for login container as requested
    /*
    const throttle = (func, limit) => {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }

    const handleMouseMove = (e) => {
      const { clientX, clientY } = e;
      const rect = authContainer.getBoundingClientRect();
      const isMouseInsidePanel =
        clientX >= rect.left &&
        clientX >= rect.right &&
        clientY >= rect.top &&
        clientY <= rect.bottom;

      if (isMouseInsidePanel) {
        authContainer.style.transform = 'rotateY(0deg) rotateX(0deg)';
      } else {
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const normalizedX = (clientX - (window.innerWidth / 2)) / (window.innerWidth / 2);
        const normalizedY = (clientY - (window.innerHeight / 2)) / (window.innerHeight / 2);
        const maxRotate = 15;
        const rotateY = normalizedX * maxRotate;
        const rotateX = normalizedY * -maxRotate;
        authContainer.style.transform = `rotateY(${rotateY}deg) rotateX(${rotateX}deg)`;
      }
    };

    document.removeEventListener('mousemove', throttle(handleMouseMove, 16));
    document.removeEventListener('mouseleave', () => {
      authContainer.style.transform = 'rotateY(0deg) rotateX(0deg)';
    });
    */

    /**
     * Uploads an image to imgbb.com.
     * @param {File} imageFile - The image file to upload.
     * @returns {Promise<string|null>} - A promise that resolves with the image URL or null on failure.
     */
    async function uploadImageToImgBB(imageFile) {
      const formData = new FormData();
      formData.append('image', imageFile);

      try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (data.success) {
          return data.data.url;
        } else {
          console.error('ImgBB upload failed:', data.error.message);
          showCustomAlert('Image upload failed: ' + data.error.message);
          return null;
        }
      } catch (error) {
        console.error('Error uploading image to ImgBB:', error);
        showCustomAlert('Error uploading image: ' + error.message);
        return null;
      }
    }

    // Handle image file selection for preview and cropping
    profileImageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          // Show the cropping modal
          cropModal.style.display = 'flex';
          imageToCrop.src = event.target.result;

          // Destroy previous cropper instance if any
          if (cropper) {
            cropper.destroy();
          }

          // Initialize Cropper.js
          cropper = new Cropper(imageToCrop, {
            aspectRatio: 1, // Force square aspect ratio for profile pictures
            viewMode: 1, // Restrict the crop box to not exceed the canvas
            // Other options as needed
          });
        };
        reader.readAsDataURL(file);
      } else {
        // If no file selected, revert to default or current saved image
        const user = auth.currentUser;
        if (user) {
          loadProfile(user); // Reload profile to get current image
        } else {
          profileImg.src = "https://placehold.co/100x100/A239CA/FFFFFF?text=P";
        }
      }
    });

    // Handle Crop & Upload button click
    cropAndUploadButton.addEventListener('click', () => {
      if (cropper) {
        showLoadingScreen();
        cropper.getCroppedCanvas({
          width: 200, // Desired width for the cropped image
          height: 200, // Desired height
        }).toBlob(async (blob) => {
          if (blob) {
            // Convert blob to File object for uploadImageToImgBB
            const croppedFile = new File([blob], "profile_image.png", { type: "image/png" });
            selectedProfileImageFile = croppedFile; // Store the cropped file

            // Hide cropping modal
            cropModal.style.display = 'none';
            hideLoadingScreen(); // Hide loading screen initially, will show again on save
            profileImg.src = URL.createObjectURL(croppedFile); // Set preview image to cropped image

          } else {
            hideLoadingScreen();
            showCustomAlert('Failed to crop image.');
          }
        }, 'image/png'); // Specify image format
      }
    });

    // Handle Cancel Crop button click
    cancelCropButton.addEventListener('click', () => {
      cropModal.style.display = 'none';
      if (cropper) {
        cropper.destroy();
      }
      selectedProfileImageFile = null; // Clear the selected file
      profileImageUpload.value = ''; // Reset file input
      // Revert preview image to current user's profile image or placeholder
      const user = auth.currentUser;
      if (user) {
        loadProfile(user);
      } else {
        profileImg.src = "https://placehold.co/100x100/A239CA/FFFFFF?text=P";
      }
    });

    /**
     * Sets user presence in Realtime Database and updates Firestore status.
     * @param {string} userId - The UID of the user.
     * @param {boolean} isOnline - True if online, false if offline.
     */
    async function setUserOnlineStatus(userId, isOnline) {
        const userStatusRTDBRef = ref(rtdb, 'presence/' + userId);
        const userDocRef = getUserProfileDocRef(userId);

        if (isOnline) {
            // Set up onDisconnect to set status to offline when client disconnects
            onDisconnect(userStatusRTDBRef).set(false).then(() => {
                // If onDisconnect is set successfully, set user's current status to true
                set(userStatusRTDBRef, true);
            }).catch(error => {
                console.error("Error setting onDisconnect or initial RTDB presence:", error);
                // Even if RTDB fails, try to update Firestore.
                setDoc(userDocRef, { status: 'Online' }, { merge: true }).catch(e => {
                    console.error("Fallback: Error updating Firestore status to online:", e);
                });
            });

            // Update Firestore for display purposes (always try to set/update)
            try {
                await setDoc(userDocRef, { status: 'Online' }, { merge: true });
            } catch (e) {
                console.error("Error updating Firestore status to online:", e);
            }
        } else {
            // If logging out explicitly, cancel onDisconnect and set offline immediately
            onDisconnect(userStatusRTDBRef).cancel(); // Cancel any pending onDisconnect for this user
            set(userStatusRTDBRef, false); // Set offline immediately in RTDB
            try {
                await setDoc(userDocRef, { status: 'Offline' }, { merge: true });
            } catch (e) {
                console.error("Error updating Firestore status to offline:", e);
            }
        }
    }

    /**
     * Loads user profile data from Firestore and updates the UI.
     * @param {Object} user - The Firebase User object.
     */
    async function loadProfile(user) {
      if (!user) {
        document.body.classList.remove('profile-active');
        authContainer.classList.remove('hidden');
        authContainer.classList.add('visible');
        profileSection.classList.remove('visible');
        profileSection.classList.add('hidden');
        return;
      }

      const userDocRef = getUserProfileDocRef(user.uid); // Changed
      try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          const profile = docSnap.data();
          profileUsernameDisplay.textContent = profile.username || '@Username';
          profileNameDisplay.textContent = profile.name || 'User Name';
          profileEmailDisplay.textContent = profile.email || 'No Email';
          profileDobDisplay.textContent = profile.dob || 'No DOB';
          profileGenderDisplay.textContent = profile.gender || 'No Gender';
          profileCountryDisplay.textContent = profile.country || 'No Country';
          profileLanguageDisplay.textContent = profile.language || 'No Language';
          profileStatusDisplay.textContent = profile.status || 'Offline';
          profileStatusDisplay.style.color = profile.status === 'Online' ? '#8BC34A' : '#FF7B54'; // Set color
          profileImg.src = profile.profileImage || "https://placehold.co/100x100/A239CA/FFFFFF?text=P"; // Load profile image

          profileUsernameInput.value = profile.username || '';
          profileNameInput.value = profile.name || '';
          profileDobInput.value = profile.dob || '';
          populateSelect(profileGenderSelect, genders, profile.gender);
          populateSelect(profileCountrySelect, countries, profile.country);
          populateSelect(profileLanguageSelect, languages, profile.language);

          document.body.classList.add('profile-active');
          authContainer.classList.remove('visible');
          authContainer.classList.add('hidden');
          profileSection.classList.remove('hidden');
          profileSection.classList.add('visible');
        } else {
          // Default values if no profile document exists
          // This block ensures that even if the document doesn't exist yet,
          // the UI is populated with reasonable defaults or user's Google profile info.
          profileUsernameDisplay.textContent = user.displayName || '@' + user.email.split('@')[0];
          profileNameDisplay.textContent = user.displayName || 'User Name';
          profileEmailDisplay.textContent = user.email || 'No Email';
          profileDobDisplay.textContent = 'No DOB';
          profileGenderDisplay.textContent = 'No Gender';
          profileCountryDisplay.textContent = 'No Country';
          profileLanguageDisplay.textContent = 'No Language';
          profileStatusDisplay.textContent = 'Offline'; // Default to offline if no doc
          profileStatusDisplay.style.color = '#FF7B54'; // Set default color
          profileImg.src = user.photoURL || "https://placehold.co/100x100/A239CA/FFFFFF?text=P"; // Use Google photoURL or placeholder

          profileUsernameInput.value = user.displayName || '@' + user.email.split('@')[0];
          profileNameInput.value = user.displayName || '';
          profileDobInput.value = '';
          populateSelect(profileGenderSelect, genders, 'Prefer not to say');
          populateSelect(profileCountrySelect, countries, 'United States');
          populateSelect(profileLanguageSelect, languages, 'English');

          document.body.classList.add('profile-active');
          authContainer.classList.remove('visible');
          authContainer.classList.add('hidden');
          profileSection.classList.remove('hidden');
          profileSection.classList.add('visible');
        }
      } catch (error) {
        console.error('Error fetching profile:', error);
        showCustomAlert('Failed to load profile data.');
        document.body.classList.remove('profile-active');
        authContainer.classList.remove('hidden');
        authContainer.classList.add('visible');
        profileSection.classList.remove('visible');
        profileSection.classList.add('hidden');
      }
    }

    // Save Profile Changes
    saveProfileButton.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showCustomAlert('You must be logged in to update your profile.');
        return;
      }

      const username = profileUsernameInput.value.trim();
      const name = profileNameInput.value.trim();
      const dob = profileDobInput.value;
      const gender = profileGenderSelect.value;
      const country = profileCountrySelect.value;
      const language = profileLanguageSelect.value;
      let profileImageUrl = profileImg.src; // Start with current image source, which might be a blob URL temporarily

      if (!username.startsWith('@') || username.length < 4) {
        showCustomAlert('Username must start with @ and be at least 4 characters');
        return;
      }
      if (!name) {
        showCustomAlert('Please enter your name.');
        return;
      }
      if (!dob) {
        showCustomAlert('Please enter your date of birth.');
        return;
      }
      if (!gender) {
        showCustomAlert('Please select your gender.');
        return;
      }
      if (!country) {
        showCustomAlert('Please select your country.');
        return;
      }
      if (!language) {
        showCustomAlert('Please select your preferred language.');
        return;
      }

      const dobDate = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - dobDate.getFullYear();
      const monthDiff = today.getMonth() - dobDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dobDate.getDate())) {
        age--;
      }
      if (age < 13) {
        showCustomAlert('You must be at least 13 years old to update your profile.');
        return;
      }

      try {
        showLoadingScreen();

        // Upload the selectedProfileImageFile (which is now the cropped image)
        if (selectedProfileImageFile) {
          const uploadedUrl = await uploadImageToImgBB(selectedProfileImageFile);
          if (uploadedUrl) {
            profileImageUrl = uploadedUrl;
          } else {
            hideLoadingScreen();
            return; // If image upload fails, stop here
          }
        }

        await updateProfile(user, { displayName: username, photoURL: profileImageUrl });
        // Update user profile data in Firestore. The path is now:
        // artifacts/{appId}/users/{uid}/profile/data
        await updateDoc(getUserProfileDocRef(user.uid), {
          username,
          name,
          dob,
          gender,
          country,
          language,
          profileImage: profileImageUrl // Save the image URL
        });

        // Update displayed profile info (onSnapshot will handle profile status display)
        profileUsernameDisplay.textContent = username;
        profileNameDisplay.textContent = name;
        profileDobDisplay.textContent = dob;
        profileGenderDisplay.textContent = gender;
        profileCountryDisplay.textContent = country;
        profileLanguageDisplay.textContent = language;
        profileImg.src = profileImageUrl; // Ensure the display image is the final URL

        // Clear the selected file after successful upload/save
        selectedProfileImageFile = null;
        profileImageUpload.value = ''; // Reset file input

        setTimeout(() => {
          hideLoadingScreen();
          showCustomAlert('Profile updated successfully!');
        }, 1000);
      } catch (error) {
        hideLoadingScreen();
        console.error('Error updating profile:', error);
        showCustomAlert('Failed to update profile: ' + error.message);
      }
    });

    // Navigation items
    const navItems = document.querySelectorAll('.profile-section .nav-item');
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
      });
    });

    // Firebase Auth State Listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("User signed in:", user.uid);
            // Ensure profile data is loaded and status is set online.
            // loadProfile will also set the initial status display.
            await loadProfile(user);
            await setUserOnlineStatus(user.uid, true);

            // Listen for changes in the user's Firestore document to update the status display
            const userDocRef = getUserProfileDocRef(user.uid);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const profile = docSnap.data();
                    profileStatusDisplay.textContent = profile.status || 'Offline';
                    profileStatusDisplay.style.color = profile.status === 'Online' ? '#8BC34A' : '#FF7B54';
                } else {
                    // If the document somehow gets deleted while user is signed in,
                    // reset status display and log.
                    profileStatusDisplay.textContent = 'Offline';
                    profileStatusDisplay.style.color = '#FF7B54';
                    console.warn("User profile document disappeared while signed in.");
                }
            }, (error) => {
                console.error("Error listening to Firestore status changes:", error);
            });

        } else {
            console.log("User signed out.");
            // Reset UI to login state
            document.body.classList.remove('profile-active');
            authContainer.classList.remove('hidden');
            authContainer.classList.add('visible');
            profileSection.classList.remove('visible');
            profileSection.classList.add('hidden');
            // Clear any active Firestore listeners for the previous user's profile status
            // (This is implicitly handled if onSnapshot is scoped to the user's UID and re-established on new login)
        }
    });

    // Modify logout button event listener to handle status
    logoutButton.addEventListener('click', async () => {
      try {
        showLoadingScreen();
        const user = auth.currentUser;
        if (user) {
            // Explicitly set user offline before signing out
            await setUserOnlineStatus(user.uid, false);
        }
        await signOut(auth);
        setTimeout(() => {
          hideLoadingScreen();
          showCustomAlert('Logged out successfully!');
        }, 1000);
      } catch (error) {
        hideLoadingScreen();
        showCustomAlert('Logout failed: ' + error.message);
      }
    });

    /* --- VibeRoom Specific Functions and Event Listeners --- */

    /**
     * Generates a random alphanumeric string for room ID/password.
     * @param {number} length - The desired length of the string.
     * @returns {string} The generated random string.
     */
    function generateRandomId(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    /**
     * Navigates to the VibeRoom main section.
     */
    function showVibeRoomMain() {
        if (!auth.currentUser) {
            showCustomAlert('Please log in to access VibeRoom.');
            return;
        }
        profileSection.classList.add('hidden');
        profileSection.classList.remove('visible');
        viberoomSection.classList.remove('hidden');
        viberoomSection.classList.add('visible');
        document.body.classList.remove('profile-active'); // Ensure background is visible if coming from profile
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        navVibeRoomMain.classList.add('active'); // Set VibeRoom nav item active
        // Ensure VibeRoom nav items have icons
        navVibeRoomHome.innerHTML = '<i class="fas fa-home"></i><span>Home</span>';
        navVibeRoomMain.innerHTML = '<i class="fas fa-music"></i><span>VibeRoom</span>';
        navVibeRoomBuddies.innerHTML = '<i class="fas fa-user-group"></i><span>Buddies</span>';
        navVibeRoomProfile.innerHTML = '<i class="fas fa-user"></i><span>Profile</span>';
    }

    // Event listener for VibeRoom main navigation item
    navVibeRoomMainNav.addEventListener('click', (e) => {
        e.preventDefault();
        showVibeRoomMain();
    });

    // Event listeners for VibeRoom section navigation (home, buddies, profile)
    navVibeRoomHome.addEventListener('click', (e) => {
        e.preventDefault();
        showCustomAlert('Home section coming soon!');
    });
    navVibeRoomBuddies.addEventListener('click', (e) => {
        e.preventDefault();
        showCustomAlert('Buddies section coming soon!');
    });
    navVibeRoomProfile.addEventListener('click', (e) => {
        e.preventDefault();
        profileSection.classList.remove('hidden');
        profileSection.classList.add('visible');
        viberoomSection.classList.add('hidden');
        viberoomSection.classList.remove('visible');
        document.body.classList.add('profile-active');
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.getElementById('nav-profile').classList.add('active'); // Set profile nav item active
    });

    // --- Private Room Logic ---

    privateRoomOption.addEventListener('click', () => {
        if (userInRoom) {
            showCustomAlert('You are already in a room. Please exit the current room before creating or joining another.');
            return;
        }
        privateRoomModalTitle.textContent = 'Create Private Room';
        roomMaxPersonsSelect.value = '4'; // Default to 4 persons
        roomCategorySelect.value = 'study'; // Default to study
        joinRoomInputs.classList.add('hidden');
        privateRoomActionButton.textContent = 'Create Room';
        createdRoomDetails.classList.add('hidden'); // Hide details when creating
        privateRoomModal.style.display = 'flex';
    });

    joinRoomOption.addEventListener('click', () => {
        if (userInRoom) {
            showCustomAlert('You are already in a room. Please exit the current room before creating or joining another.');
            return;
        }
        privateRoomModalTitle.textContent = 'Join Private Room';
        joinRoomInputs.classList.remove('hidden');
        roomMaxPersonsSelect.parentElement.classList.add('hidden'); // Hide max persons for joining
        roomCategorySelect.parentElement.classList.add('hidden'); // Hide category for joining
        privateRoomActionButton.textContent = 'Join Room';
        createdRoomDetails.classList.add('hidden'); // Hide details when joining
        privateRoomModal.style.display = 'flex';
    });

    closePrivateRoomModal.addEventListener('click', () => {
        privateRoomModal.style.display = 'none';
        // Reset modal state
        joinRoomIdInput.value = '';
        joinRoomPasswordInput.value = '';
        roomMaxPersonsSelect.parentElement.classList.remove('hidden'); // Show max persons again
        roomCategorySelect.parentElement.classList.remove('hidden'); // Show category again
    });

    // Handle "Coming Soon" categories
    roomCategorySelect.addEventListener('change', () => {
        if (roomCategorySelect.value !== 'study') {
            showCustomAlert('This category is coming soon! Please select "Study".');
            roomCategorySelect.value = 'study';
        }
    });

    privateRoomActionButton.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert('You must be logged in to create or join a room.');
            return;
        }

        if (privateRoomActionButton.textContent === 'Create Room') {
            const maxPersons = parseInt(roomMaxPersonsSelect.value);
            const category = roomCategorySelect.value;
            const roomId = generateRandomId(6);
            const roomPassword = generateRandomId(8);

            showLoadingScreen();
            try {
                // Store room data in Firestore. The path is now:
                // artifacts/{appId}/public/data/rooms/{roomId}
                await setDoc(getRoomDocRef(roomId), {
                    creatorId: user.uid,
                    maxParticipants: maxPersons,
                    category: category,
                    password: roomPassword,
                    participants: [user.uid], // Creator is the first participant
                    isActive: true,
                    createdAt: serverTimestamp()
                });
                currentRoomId = roomId;
                isRoomCreator = true;
                userInRoom = true; // Set user in room flag
                displayRoomId.textContent = roomId;
                displayRoomPassword.textContent = roomPassword;
                createdRoomDetails.classList.remove('hidden');
                privateRoomActionButton.classList.add('hidden'); // Hide create button
                hideLoadingScreen();
                showCustomAlert('Room created successfully! Share the ID and Password.');
            } catch (error) {
                hideLoadingScreen();
                showCustomAlert('Failed to create room: ' + error.message);
                console.error('Error creating room:', error);
            }
        } else { // Join Room
            const roomId = joinRoomIdInput.value.trim();
            const roomPassword = joinRoomPasswordInput.value.trim();

            if (!roomId || !roomPassword) {
                showCustomAlert('Please enter both Room ID and Password.');
                return;
            }

            showLoadingScreen();
            try {
                const roomDocRef = getRoomDocRef(roomId); // Changed
                const roomSnap = await getDoc(roomDocRef);

                if (!roomSnap.exists()) {
                    hideLoadingScreen();
                    showCustomAlert('Room not found.');
                    return;
                }

                const roomData = roomSnap.data();
                if (roomData.password !== roomPassword) {
                    hideLoadingScreen();
                    showCustomAlert('Incorrect room password.');
                    return;
                    }
                if (!roomData.isActive) {
                    hideLoadingScreen();
                    showCustomAlert('This room is no longer active.');
                    return;
                }
                if (roomData.participants.length >= roomData.maxParticipants) {
                    hideLoadingScreen();
                    showCustomAlert('Room is full.');
                    return;
                }
                if (roomData.participants.includes(user.uid)) {
                    hideLoadingScreen();
                    showCustomAlert('You are already in this room.');
                    currentRoomId = roomId; // Set current room ID even if already in
                    isRoomCreator = false;
                    userInRoom = true; // Set user in room flag
                    startVideoCall(roomData.maxParticipants); // Proceed to video call
                    return;
                }

                // Add user to participants
                const updatedParticipants = [...roomData.participants, user.uid];
                await updateDoc(roomDocRef, { participants: updatedParticipants });

                currentRoomId = roomId;
                isRoomCreator = false;
                userInRoom = true; // Set user in room flag
                hideLoadingScreen();
                showCustomAlert('Successfully joined room!');
                startVideoCall(roomData.maxParticipants); // Proceed to video call

            } catch (error) {
                hideLoadingScreen();
                showCustomAlert('Failed to join room: ' + error.message);
                console.error('Error joining room:', error);
            }
        }
    });

    // Copy Room ID/Password
    copyButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const targetId = e.currentTarget.dataset.target;
            const textToCopy = document.getElementById(targetId).textContent;
            // Use document.execCommand('copy') for clipboard operations in iframes
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showCustomAlert('Copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                showCustomAlert('Failed to copy to clipboard.');
            } finally {
                document.body.removeChild(tempInput);
            }
        });
    });

    startPrivateRoomButton.addEventListener('click', async () => {
        if (currentRoomId) {
            privateRoomModal.style.display = 'none';
            const roomDoc = await getDoc(getRoomDocRef(currentRoomId)); // Changed
            if (roomDoc.exists()) {
                startVideoCall(roomDoc.data().maxParticipants);
            } else {
                showCustomAlert('Room not found or no longer exists.');
                currentRoomId = null;
                isRoomCreator = false;
                userInRoom = false; // Reset user in room flag
            }
        }
    });

    // --- Video Call Room Logic ---

    /**
     * Initializes PeerJS and gets local media stream.
     * @param {number} maxParticipants - Maximum number of participants in the room.
     */
    async function startVideoCall(maxParticipants) {
        showLoadingScreen();
        viberoomSection.classList.add('hidden');
        viberoomSection.classList.remove('visible');
        videoCallRoom.classList.remove('hidden');
        videoCallRoom.classList.add('visible');
        document.body.classList.add('profile-active'); // Keep background off for video room

        currentRoomName.textContent = `Room: ${currentRoomId}`;
        if (isRoomCreator) {
            endRoomBtn.classList.remove('hidden');
        } else {
            endRoomBtn.classList.add('hidden');
        }

        // Clear any pending reconnection attempts
        if (reconnectTimeoutId) {
            clearTimeout(reconnectTimeoutId);
            reconnectTimeoutId = null;
            console.log("Cleared pending reconnection timeout.");
        }

        try {
            // Request camera and microphone permissions if not already granted
            if (!localStream) {
                console.log("Requesting local media stream...");
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                localVideo.muted = true; // Mute local preview
                console.log("Local media stream obtained.");
            }

            // Destroy existing peer instance if any before creating a new one
            if (peer) {
                console.log("Destroying existing PeerJS instance...");
                peer.destroy();
                peer = null;
            }
            
            console.log("Initializing new PeerJS instance...");
            peer = new Peer(auth.currentUser.uid, {
                host: '0.peerjs.com', // Using PeerServer cloud
                secure: true, // Use HTTPS
                port: 443,
                debug: 3 // Add debug level for more verbose logging
            });

            peer.on('open', async (id) => {
                console.log('PeerJS opened. My Peer ID:', id);
                hideLoadingScreen();
                currentReconnectAttempt = 0; // Reset reconnect attempts on successful connection

                // If joining an existing room, call existing participants
                if (!isRoomCreator) {
                    console.log("Joining existing room. Fetching participants...");
                    const roomDocRef = getRoomDocRef(currentRoomId);
                    const roomSnap = await getDoc(roomDocRef);
                    if (roomSnap.exists()) {
                        const participants = roomSnap.data().participants || [];
                        for (const participantId of participants) {
                            if (participantId !== auth.currentUser.uid) {
                                console.log(`Attempting to call existing participant: ${participantId}`);
                                const call = peer.call(participantId, localStream);
                                setupCallListeners(call, participantId);
                            }
                        }
                    } else {
                        console.warn("Room document not found when trying to join existing participants.");
                    }
                }

                // Listen for incoming calls
                peer.on('call', (call) => {
                    console.log('Incoming call from:', call.peer);
                    call.answer(localStream); // Answer the call with our stream
                    setupCallListeners(call, call.peer);
                });

                // Set up Firestore listener for room participants
                if (currentRoomId) {
                    console.log(`Setting up Firestore listener for room participants in room: ${currentRoomId}`);
                    roomParticipantsListener = onSnapshot(getRoomDocRef(currentRoomId), (docSnap) => {
                        if (docSnap.exists()) {
                            const roomData = docSnap.data();
                            const currentParticipants = roomData.participants || [];
                            const connectedPeerIds = Object.keys(connectedPeers);
                            console.log("Firestore update: Current participants:", currentParticipants, "Connected peers:", connectedPeerIds);

                            // Add new participants
                            for (const participantId of currentParticipants) {
                                if (participantId !== auth.currentUser.uid && !connectedPeerIds.includes(participantId)) {
                                    console.log(`New participant detected: ${participantId}. Attempting to call...`);
                                    const call = peer.call(participantId, localStream);
                                    setupCallListeners(call, participantId);
                                }
                            }

                            // Remove disconnected participants
                            for (const connectedPeerId of connectedPeerIds) {
                                if (!currentParticipants.includes(connectedPeerId)) {
                                    console.log(`Participant ${connectedPeerId} left. Closing call and removing video element.`);
                                    if (connectedPeers[connectedPeerId] && connectedPeers[connectedPeerId].call) {
                                        connectedPeers[connectedPeerId].call.close();
                                    }
                                    if (connectedPeers[connectedPeerId] && connectedPeers[connectedPeerId].videoElement) {
                                        connectedPeers[connectedPeerId].videoElement.parentElement.remove();
                                    }
                                    delete connectedPeers[connectedPeerId];
                                }
                            }
                        } else {
                            // Room no longer exists (e.g., creator ended it)
                            console.log("Firestore update: Room no longer exists. Exiting call.");
                            showCustomAlert("The room has been ended by the creator or no longer exists.").then(() => {
                                exitRoom();
                            });
                        }
                    }, (error) => {
                        console.error("Error listening to room participants:", error);
                    });
                }

            });

            // Handle PeerJS connection close/disconnection
            peer.on('disconnected', () => {
                console.warn('PeerJS disconnected. Attempting to reconnect...');
                if (currentReconnectAttempt < MAX_RECONNECT_ATTEMPTS) {
                    currentReconnectAttempt++;
                    const reconnectDelay = Math.pow(2, currentReconnectAttempt) * 1000; // Exponential backoff
                    showCustomAlert(`Lost connection to video call. Attempting to reconnect in ${reconnectDelay / 1000} seconds... (Attempt ${currentReconnectAttempt}/${MAX_RECONNECT_ATTEMPTS})`);
                    reconnectTimeoutId = setTimeout(() => {
                        console.log(`Reconnecting PeerJS (Attempt ${currentReconnectAttempt})...`);
                        if (currentRoomId && auth.currentUser) { // Only re-init if still in a room and authenticated
                            startVideoCall(maxParticipants); // Re-initialize PeerJS and call setup
                        } else {
                            console.log("Not in a room or not authenticated, cannot reconnect. Exiting.");
                            exitRoom(); // If not in a room or logged out, just exit
                        }
                    }, reconnectDelay);
                } else {
                    console.error('Failed to reconnect to video call after multiple attempts. Exiting room.');
                    showCustomAlert('Failed to reconnect to video call after multiple attempts. Exiting room.');
                    exitRoom();
                }
            });

            // Handle PeerJS errors
            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                if (currentReconnectAttempt < MAX_RECONNECT_ATTEMPTS) {
                    currentReconnectAttempt++;
                    const reconnectDelay = Math.pow(2, currentReconnectAttempt) * 1000; // Exponential backoff
                    showCustomAlert(`PeerJS connection error: ${err.message}. Attempting to reconnect in ${reconnectDelay / 1000} seconds... (Attempt ${currentReconnectAttempt}/${MAX_RECONNECT_ATTEMPTS})`);
                    reconnectTimeoutId = setTimeout(() => {
                        console.log(`Reconnecting PeerJS due to error (Attempt ${currentReconnectAttempt})...`);
                        if (currentRoomId && auth.currentUser) {
                            startVideoCall(maxParticipants);
                        } else {
                            console.log("Not in a room or not authenticated, cannot reconnect. Exiting.");
                            exitRoom();
                        }
                    }, reconnectDelay);
                } else {
                    console.error('Persistent PeerJS errors. Exiting room.');
                    showCustomAlert('Persistent PeerJS errors. Exiting room.');
                    exitRoom();
                }
            });

        } catch (error) {
            hideLoadingScreen();
            console.error('Error getting user media or PeerJS setup:', error);
            showCustomAlert('Failed to get camera/mic access or start video call: ' + error.message).then(() => {
                exitRoom();
            });
        }
    }

    /**
     * Sets up listeners for a PeerJS call object.
     * @param {MediaConnection} call - The PeerJS MediaConnection object.
     * @param {string} peerId - The ID of the remote peer.
     */
    function setupCallListeners(call, peerId) {
        console.log(`Setting up call listeners for peer: ${peerId}`);
        call.on('stream', (remoteStream) => {
            console.log('Received remote stream from:', peerId);
            // Check if a video element for this peer already exists to prevent duplicates
            if (!connectedPeers[peerId] && !document.querySelector(`.video-feed-container[data-peer-id="${peerId}"]`)) {
                const videoContainer = document.createElement('div');
                videoContainer.classList.add('video-feed-container');
                videoContainer.dataset.peerId = peerId; // Store peerId for easy lookup

                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = remoteStream;
                remoteVideo.autoplay = true;
                remoteVideo.playsinline = true; // Important for iOS

                const controlsDiv = document.createElement('div');
                controlsDiv.classList.add('video-feed-controls');

                const camToggleBtn = document.createElement('button');
                camToggleBtn.innerHTML = '<i class="fas fa-video"></i>';
                camToggleBtn.classList.add('active'); // Assume active initially
                camToggleBtn.addEventListener('click', () => {
                    // Toggle remote video display (local control)
                    remoteVideo.style.display = remoteVideo.style.display === 'none' ? 'block' : 'none';
                    camToggleBtn.classList.toggle('active');
                    camToggleBtn.classList.toggle('inactive');
                    camToggleBtn.querySelector('i').classList.toggle('fa-video-slash');
                    camToggleBtn.querySelector('i').classList.toggle('fa-video');
                });

                const micToggleBtn = document.createElement('button');
                micToggleBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                micToggleBtn.classList.add('active'); // Assume active initially
                micToggleBtn.addEventListener('click', () => {
                    // Toggle remote audio (local control)
                    remoteVideo.muted = !remoteVideo.muted;
                    micToggleBtn.classList.toggle('active');
                    micToggleBtn.classList.toggle('inactive');
                    micToggleBtn.querySelector('i').classList.toggle('fa-microphone-slash');
                    micToggleBtn.querySelector('i').classList.toggle('fa-microphone');
                });

                controlsDiv.appendChild(camToggleBtn);
                controlsDiv.appendChild(micToggleBtn);
                videoContainer.appendChild(remoteVideo);
                videoContainer.appendChild(controlsDiv);
                videoFeedsSection.appendChild(videoContainer);

                connectedPeers[peerId] = {
                    call: call,
                    stream: remoteStream,
                    videoElement: remoteVideo,
                    controls: controlsDiv
                };
                console.log(`Added remote video for peer: ${peerId}`);
            } else {
                console.log(`Video feed for ${peerId} already exists or is being processed. Skipping.`);
            }
        });

        call.on('close', () => {
            console.log('Call closed with:', peerId);
            if (connectedPeers[peerId]) {
                connectedPeers[peerId].videoElement.parentElement.remove();
                delete connectedPeers[peerId];
                console.log(`Removed remote video for peer: ${peerId}`);
            }
        });

        call.on('error', (err) => {
            console.error('Call error with', peerId, ':', err);
            showCustomAlert(`Call error with ${peerId}: ${err.message}`);
            if (connectedPeers[peerId]) {
                connectedPeers[peerId].videoElement.parentElement.remove();
                delete connectedPeers[peerId];
                console.log(`Removed remote video for peer: ${peerId} due to error.`);
            }
        });
    }

    // Local camera toggle
    localCamToggle.addEventListener('click', () => {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                localCamToggle.classList.toggle('active', videoTrack.enabled);
                localCamToggle.classList.toggle('inactive', !videoTrack.enabled);
                localCamToggle.querySelector('i').classList.toggle('fa-video-slash', !videoTrack.enabled);
                localCamToggle.querySelector('i').classList.toggle('fa-video', videoTrack.enabled);
                console.log(`Local camera toggled: ${videoTrack.enabled ? 'On' : 'Off'}`);
            }
        }
    });

    // Local microphone toggle
    localMicToggle.addEventListener('click', () => {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                localMicToggle.classList.toggle('active', audioTrack.enabled);
                localMicToggle.classList.toggle('inactive', !audioTrack.enabled);
                localMicToggle.querySelector('i').classList.toggle('fa-microphone-slash', !audioTrack.enabled);
                localMicToggle.querySelector('i').classList.toggle('fa-microphone', audioTrack.enabled);
                console.log(`Local microphone toggled: ${audioTrack.enabled ? 'On' : 'Off'}`);
            }
        }
    });

    // Exit Room Function
    async function exitRoom() {
        showLoadingScreen();
        console.log("Exiting room...");

        // Clear any pending reconnection attempts
        if (reconnectTimeoutId) {
            clearTimeout(reconnectTimeoutId);
            reconnectTimeoutId = null;
            console.log("Cleared pending reconnection timeout during exit.");
        }
        currentReconnectAttempt = 0; // Reset attempts

        // Stop all local media tracks
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localVideo.srcObject = null;
            localStream = null;
            console.log("Local media tracks stopped.");
        }

        // Close all PeerJS connections
        for (const peerId in connectedPeers) {
            if (connectedPeers[peerId].call) {
                connectedPeers[peerId].call.close();
                console.log(`Closed PeerJS call with ${peerId}.`);
            }
            if (connectedPeers[peerId].videoElement) {
                connectedPeers[peerId].videoElement.parentElement.remove(); // Remove video element
                console.log(`Removed video element for ${peerId}.`);
            }
            delete connectedPeers[peerId];
        }
        if (peer) {
            peer.destroy();
            peer = null;
            console.log("PeerJS instance destroyed.");
        }

        // Stop music playback when exiting room
        pauseSong();
        currentAudio.currentTime = 0; // Reset music to start
        console.log("Music stopped and reset.");

        // Remove user from room participants in Firestore
        if (currentRoomId && auth.currentUser) {
            console.log(`Removing user ${auth.currentUser.uid} from room ${currentRoomId} participants.`);
            const roomDocRef = getRoomDocRef(currentRoomId); // Changed
            const roomSnap = await getDoc(roomDocRef);
            if (roomSnap.exists()) {
                const roomData = roomSnap.data();
                const updatedParticipants = roomData.participants.filter(uid => uid !== auth.currentUser.uid);
                await updateDoc(roomDocRef, { participants: updatedParticipants });
                console.log("User removed from Firestore room participants.");
            } else {
                console.warn("Room document not found during exit, cannot remove participant.");
            }
        }

        // Detach Firestore listeners
        if (roomParticipantsListener) {
            roomParticipantsListener(); // Unsubscribe
            roomParticipantsListener = null;
            console.log("Firestore room participants listener unsubscribed.");
        }
        if (roomStatusListener) {
            roomStatusListener(); // Unsubscribe
            roomStatusListener = null;
            console.log("Firestore room status listener unsubscribed.");
        }

        currentRoomId = null;
        isRoomCreator = false;
        userInRoom = false; // Reset user in room flag
        hideLoadingScreen();
        videoCallRoom.classList.add('hidden');
        videoCallRoom.classList.remove('visible');
        showVibeRoomMain(); // Redirect to VibeRoom main page
        showCustomAlert('You have exited the room.');
    }

    // End Room Function (Creator only)
    endRoomBtn.addEventListener('click', async () => {
        showCustomAlert('Are you sure you want to end the room for everyone?').then(async (confirmed) => {
            if (confirmed && currentRoomId && isRoomCreator) {
                showLoadingScreen();
                console.log(`Ending room ${currentRoomId} for all participants.`);
                try {
                    // Set room to inactive and then delete
                    const roomDocRef = getRoomDocRef(currentRoomId); // Changed
                    await updateDoc(roomDocRef, { isActive: false }); // Signal other users
                    await deleteDoc(roomDocRef); // Delete the room
                    console.log("Room marked inactive and deleted from Firestore.");
                    showCustomAlert('Room ended for all participants.').then(() => {
                        exitRoom(); // Clean up local state and redirect
                    });
                } catch (error) {
                    hideLoadingScreen();
                    showCustomAlert('Failed to end room: ' + error.message);
                    console.error('Error ending room:', error);
                }
            }
        });
    });

    // Exit Room Button Listener
    exitRoomBtn.addEventListener('click', () => {
        showCustomAlert('Are you sure you want to exit the room?').then((confirmed) => {
            if (confirmed) {
                exitRoom();
            }
        });
    });


    // --- Gemini Chatbox Logic ---
    sendGeminiChatButton.addEventListener('click', async () => {
      const userMessage = geminiChatInput.value.trim();
      if (userMessage) {
        // Display user message
        const userChatBubble = document.createElement('div');
        userChatBubble.classList.add('chat-message', 'user');
        userChatBubble.textContent = userMessage;
        geminiChatMessages.appendChild(userChatBubble);
        geminiChatMessages.scrollTop = geminiChatMessages.scrollHeight; // Scroll to bottom
        geminiChatInput.value = '';

        // Add to chat history
        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

        // Show loading indicator
        const loadingBubble = document.createElement('div');
        loadingBubble.classList.add('chat-message', 'gemini');
        loadingBubble.innerHTML = `<p>Gemini is typing<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></p>`;
        geminiChatMessages.appendChild(loadingBubble);
        geminiChatMessages.scrollTop = geminiChatMessages.scrollHeight;

        try {
          const payload = { contents: chatHistory };
          const apiKey = "AIzaSyDf6RP1GvUleF7TZsu1Jz6xy48GySXdoaQ"; // Canvas will provide this at runtime
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await response.json();

          // Remove loading indicator
          if (geminiChatMessages.contains(loadingBubble)) {
            geminiChatMessages.removeChild(loadingBubble);
          }

          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
            const geminiResponseText = result.candidates[0].content.parts[0].text;

            // Display Gemini response
            const geminiChatBubble = document.createElement('div');
            geminiChatBubble.classList.add('chat-message', 'gemini');
            geminiChatBubble.innerHTML = `<p>${geminiResponseText}</p>`;
            geminiChatMessages.appendChild(geminiChatBubble);
            geminiChatMessages.scrollTop = geminiChatMessages.scrollHeight;

            // Add Gemini response to chat history
            chatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] });
          } else {
            const errorText = "Sorry, I couldn't get a response from Gemini.";
            const errorBubble = document.createElement('div');
            errorBubble.classList.add('chat-message', 'gemini');
            errorBubble.innerHTML = `<p>${errorText}</p>`;
            geminiChatMessages.appendChild(errorBubble);
            geminiChatMessages.scrollTop = geminiChatMessages.scrollHeight;
            console.error('Unexpected Gemini API response structure:', result);
          }
        } catch (error) {
          // Remove loading indicator on error
          if (geminiChatMessages.contains(loadingBubble)) {
            geminiChatMessages.removeChild(loadingBubble);
          }
          const errorText = `Error communicating with Gemini: ${error.message}`;
          const errorBubble = document.createElement('div');
          errorBubble.classList.add('chat-message', 'gemini');
          errorBubble.innerHTML = `<p>${errorText}</p>`;
          geminiChatMessages.appendChild(errorBubble);
          geminiChatMessages.scrollTop = geminiChatMessages.scrollHeight;
          console.error('Gemini API fetch error:', error);
        }
      }
    });

    geminiChatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendGeminiChatButton.click();
      }
    });


    // --- Music Player Logic ---

    /**
     * Loads and plays the current song from the playlist.
     */
    function loadAndPlaySong() {
        currentAudio.src = musicPlaylist[currentSongIndex].src;
        currentSongTitle.textContent = musicPlaylist[currentSongIndex].title;
        currentAudio.volume = musicVolumeSlider.value;
        currentAudio.play();
        musicPlayPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
        musicPlaying = true;
        videoCallRoom.classList.add('music-active'); // Start glowing border
    }

    /**
     * Pauses the current song.
     */
    function pauseSong() {
        currentAudio.pause();
        musicPlayPauseButton.innerHTML = '<i class="fas fa-play"></i>';
        musicPlaying = false;
        videoCallRoom.classList.remove('music-active'); // Stop glowing border
    }

    // Play/Pause Toggle
    musicPlayPauseButton.addEventListener('click', () => {
        if (musicPlaying) {
            pauseSong();
        } else {
            loadAndPlaySong();
        }
    });

    // Next Song
    musicNextButton.addEventListener('click', () => {
        currentSongIndex = (currentSongIndex + 1) % musicPlaylist.length;
        loadAndPlaySong();
    });

    // Previous Song
    musicPrevButton.addEventListener('click', () => {
        currentSongIndex = (currentSongIndex - 1 + musicPlaylist.length) % musicPlaylist.length;
        loadAndPlaySong();
    });

    // Volume Control
    musicVolumeSlider.addEventListener('input', () => {
        currentAudio.volume = musicVolumeSlider.value;
    });

    // When current song ends, play next
    currentAudio.addEventListener('ended', () => {
        musicNextButton.click();
    });

    // Initialize music player display
    currentSongTitle.textContent = musicPlaylist[currentSongIndex].title;
    currentAudio.volume = musicVolumeSlider.value;


    // --- Pomodoro Timer Logic ---

    /**
     * Formats seconds into MM:SS string.
     * @param {number} seconds - The total seconds.
     * @returns {string} Formatted time string.
     */
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    /**
     * Updates the Pomodoro timer display.
     */
    function updatePomodoroDisplay() {
        pomodoroTimerDisplay.textContent = formatTime(pomodoroTimeLeft);
    }

    /**
     * Starts or pauses the Pomodoro timer.
     */
    function togglePomodoro() {
        if (pomodoroRunning) {
            clearInterval(pomodoroInterval);
            pomodoroStartPauseText.textContent = 'Start';
            pomodoroStartPauseButton.querySelector('i').classList.remove('fa-pause');
            pomodoroStartPauseButton.querySelector('i').classList.add('fa-play');
        } else {
            pomodoroInterval = setInterval(() => {
                if (pomodoroTimeLeft > 0) {
                    pomodoroTimeLeft--;
                    updatePomodoroDisplay();
                } else {
                    clearInterval(pomodoroInterval);
                    pomodoroRunning = false;
                    pomodoroStartPauseText.textContent = 'Start';
                    pomodoroStartPauseButton.querySelector('i').classList.remove('fa-pause');
                    pomodoroStartPauseButton.querySelector('i').classList.add('fa-play');
                    showCustomAlert('Pomodoro session finished!');
                }
            }, 1000);
            pomodoroStartPauseText.textContent = 'Pause';
            pomodoroStartPauseButton.querySelector('i').classList.remove('fa-play');
            pomodoroStartPauseButton.querySelector('i').classList.add('fa-pause');
        }
        pomodoroRunning = !pomodoroRunning;
    }

    // Set Pomodoro time interval
    pomodoroTimeSelectButtons.forEach(button => {
        button.addEventListener('click', () => {
            if (pomodoroRunning) {
                showCustomAlert('Please reset the timer before changing the interval.');
                return;
            }
            pomodoroTimeSelectButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            pomodoroTimeLeft = parseInt(button.dataset.time) * 60;
            updatePomodoroDisplay();
        });
    });

    // Start/Pause Pomodoro
    pomodoroStartPauseButton.addEventListener('click', togglePomodoro);

    // Reset Pomodoro
    pomodoroResetButton.addEventListener('click', () => {
        clearInterval(pomodoroInterval);
        pomodoroRunning = false;
        pomodoroTimeLeft = parseInt(document.querySelector('.pomodoro-time-select button.active')?.dataset.time || '25') * 60;
        updatePomodoroDisplay();
        pomodoroStartPauseText.textContent = 'Start';
        pomodoroStartPauseButton.querySelector('i').classList.remove('fa-pause');
        pomodoroStartPauseButton.querySelector('i').classList.add('fa-play');
    });

    // Initial Pomodoro display update
    updatePomodoroDisplay();

    // Ensure initial active state for pomodoro buttons
    document.querySelector('.pomodoro-time-select button[data-time="25"]').classList.add('active');

  </script>
</body>
</html>
