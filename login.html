<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibeRoom - Login / Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
  <style>
    /* Global Styles */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Great+Vibes&family=Poppins:wght@300;400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: url('https://res.cloudinary.com/dpragculd/image/upload/v1748926358/StockCake-Floating_Emoji_Dreams_1748924198_e1beq3.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      perspective: 1000px;
      backdrop-filter: blur(10px);
      flex-direction: column;
      transition: background 0.5s ease, backdrop-filter 0.5s ease;
    }

    /* Remove login background when profile is visible */
    body.profile-active {
      background: none;
      backdrop-filter: none;
    }

    /* Styles specific to Login/Sign Up */
    .auth-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 40px;
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      z-index: 1;
      position: relative;
      transition: transform 0.2s ease-out, opacity 0.5s ease-in-out;
      transform-style: preserve-3d;
      max-height: 90vh;
      overflow-y: auto;
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
      /* Hide scrollbar for IE, Edge and Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    
    /* Hide scrollbar for Chrome, Safari and Opera */
    .auth-container::-webkit-scrollbar {
      display: none;
    }
    
    @media (max-width: 768px) {
      .auth-container {
        width: 95%;
        padding: 20px;
      }
    }
    
    /* Removed .auth-container::-webkit-scrollbar-track and -thumb as scrollbar is hidden */
    
    .auth-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .auth-header .logo {
      font-size: 48px;
      font-weight: 800;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
      margin-bottom: 10px;
      letter-spacing: 2px;
      animation: pulseGold 2s infinite alternate;
    }
    
    @keyframes pulseGold {
      0% {
        transform: scale(1);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
      }
      100% {
        transform: scale(1.02);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.9), 0 0 25px rgba(255, 215, 0, 0.7);
      }
    }
    
    .auth-header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }
    
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease-in-out;
      overflow: hidden;
    }
    
    .form-group.hidden-field {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
    }
    
    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .form-group input,
    .form-group select {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: rgba(138, 43, 226, 0.2);
      backdrop-filter: blur(5px);
      color: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      background: rgba(138, 43, 226, 0.3);
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
    }
    
    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .auth-btn {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      border: none;
      padding: 12px;
      border-radius: 25px;
      color: white;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .auth-btn:hover {
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
      transform: translateY(-2px);
    }
    
    .social-login {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .social-btn {
      background: rgba(255, 255, 255, 0.1);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .social-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .social-btn i {
      font-size: 20px;
      color: #fff;
    }
    
    .toggle-auth {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .toggle-auth a {
      color: #8A2BE2;
      text-decoration: none;
      font-weight: 500;
    }
    
    .toggle-auth a:hover {
      text-decoration: underline;
    }
    
    .error-message {
      color: #FF7B54;
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    
    .custom-modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    
    .custom-modal-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      margin: auto;
      padding: 20px;
      width: 80%;
      max-width: 300px;
      border-radius: 10px;
      text-align: center;
      color: #fff;
    }
    
    .custom-modal-content h3 {
      margin-bottom: 15px;
      color: #fff;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }
    
    .custom-modal-content button {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .custom-modal-content button:hover {
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.6);
      transform: translateY(-1px);
    }
    
    #loading-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 99;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: #fff;
      font-size: 3em;
      font-weight: 700;
      letter-spacing: 3px;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.6);
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    #loading-screen.hidden {
      animation: fadeOut 0.5s ease-out forwards;
    }
    
    #loading-screen p {
      margin-top: 20px;
      font-size: 0.5em;
      opacity: 0.8;
      animation: pulseText 2s infinite alternate;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @keyframes vibingAnimation {
      0% { 
        transform: scale(1) translateY(0) skewX(0); 
        opacity: 1; 
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.6);
      }
      25% {
        transform: scale(1.02) translateY(-2px) skewX(2deg);
        opacity: 0.9;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.7);
      }
      50% { 
        transform: scale(1.05) translateY(0) skewX(-2deg); 
        opacity: 1; 
        text-shadow: 0 0 25px rgba(255, 215, 0, 1), 0 0 35px rgba(255, 215, 0, 0.8);
      }
      75% {
        transform: scale(1.02) translateY(2px) skewX(2deg);
        opacity: 0.9;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.7);
      }
      100% { 
        transform: scale(1) translateY(0) skewX(0); 
        opacity: 1; 
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.6);
      }
    }
    
    @keyframes pulseText {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    #loading-screen .loading-text {
      font-family: 'Great Vibes', cursive;
      animation: vibingAnimation 2s infinite ease-in-out;
    }

    /* Styles specific to Profile */
    .profile-section {
      background: linear-gradient(135deg, #13111C 0%, #221C3E 100%);
      color: #fff;
      min-height: 100vh;
      display: none;
      flex-direction: column;
      width: 100vw;
      max-width: 100%;
      padding: 0;
      overflow-y: auto;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      z-index: 2;
    }

    .profile-section main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      /* Hide scrollbar for IE, Edge and Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    
    /* Hide scrollbar for Chrome, Safari and Opera */
    .profile-section main::-webkit-scrollbar {
      display: none;
    }

    .profile-section header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin: 0;
    }
    
    .profile-section .logo {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #FF7B54, #FFB26B);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(255, 123, 84, 0.3);
    }
    
    .profile-section .header-actions {
      display: flex;
      align-items: center;
      gap: 15px; /* Use gap for spacing between items */
    }
    
    .profile-section .notification {
      background: rgba(255, 255, 255, 0.1);
      width: 40px;
      min-width: 40px; /* Ensure minimum width */
      height: 40px;
      min-height: 40px; /* Ensure minimum height */
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .profile-section .notification:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .profile-section .notification::after {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      background: #FF7B54;
      border-radius: 50%;
      top: 5px;
      right: 5px;
    }
    
    .profile-section .logout-btn {
      background: #FF7B54;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      white-space: nowrap; /* Prevent text wrapping */
    }
    
    .profile-section .logout-btn:hover {
      box-shadow: 0 0 10px rgba(255, 123, 84, 0.5);
      transform: translateY(-2px);
    }
    
    @media (min-width: 768px) {
      .profile-section main {
        padding: 20px 40px;
      }
    }
    
    @media (max-width: 767px) {
      .profile-section main {
        padding: 20px 15px;
      }
    }
    
    .profile-section .section-heading {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .profile-section .section-heading i {
      color: #FF7B54;
    }
    
    .profile-section .profile-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .profile-section .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
    }
    
    .profile-section .profile-header .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid transparent;
      background: linear-gradient(white, white) padding-box,
                 linear-gradient(to right, #FF7B54, #FFB26B) border-box;
      margin-right: 20px;
      flex-shrink: 0; /* Prevent avatar from shrinking */
      position: relative; /* For positioning the upload icon */
    }
    
    @media (max-width: 480px) {
      .profile-section .profile-header {
        justify-content: center; /* Center align on very small screens */
        text-align: center;
      }
      .profile-section .profile-header .avatar {
        margin-right: 0;
        margin-bottom: 15px;
      }
    }

    .profile-section .profile-header .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-section .avatar-upload-overlay {
      position: absolute;
      bottom: 0;
      right: 0;
      background: rgba(138, 43, 226, 0.8);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .profile-section .avatar-upload-overlay:hover {
      background: rgba(138, 43, 226, 1);
    }

    .profile-section .avatar-upload-overlay input[type="file"] {
      display: none; /* Hide the default file input */
    }

    .profile-section .avatar-upload-overlay i {
      color: #fff;
      font-size: 14px;
    }
    
    .profile-section .profile-info {
      flex-grow: 1; /* Allow info to take available space */
    }

    .profile-section .profile-info h2 {
      font-size: 24px;
      font-weight: 600;
    }
    
    .profile-section .profile-info p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .profile-section .profile-form label {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .profile-section .profile-form input,
    .profile-section .profile-form select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background: rgba(138, 43, 226, 0.2);
      backdrop-filter: blur(5px);
      border: none;
      color: #fff;
      font-size: 14px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    
    .profile-section .profile-form input:focus,
    .profile-section .profile-form select:focus {
      outline: none;
     background: rgba(138, 43, 226, 0.2);
      backdrop-filter: blur(5px);
    }
    
    .profile-section .profile-form button {
      background: #FF7B54;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
    }
    
    .profile-section .gradient-card {
      background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
    }
    
    .profile-section .gradient-card-icon {
      background: rgba(255, 255, 255, 0.2);
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0; /* Prevent icon from shrinking */
    }
    
    .profile-section .gradient-card-text h3 {
      font-size: 18px;
      margin-bottom: 5px;
    }
    
    .profile-section .gradient-card-text p {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .profile-section nav {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin: 0;
    }
    
    .profile-section .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
      padding: 10px;
      border-radius: 10px;
    }
    
    .profile-section .nav-item:hover {
      color: #FF7B54;
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }
    
    .profile-section .nav-item.active {
      color: #FF7B54;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .profile-section .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -10px;
      width: 30px;
      height: 3px;
      background: linear-gradient(90deg, #FF7B54, #FFB26B);
      border-radius: 2px;
    }
    
    .profile-section .nav-item i {
      font-size: 24px;
      transition: all 0.3s ease;
    }
    
    .profile-section .nav-item.active i {
      text-shadow: 0 0 10px rgba(255, 123, 84, 0.5);
    }
    
    .profile-section .nav-item span {
      font-size: 12px;
      font-weight: 500;
    }

    /* Utility classes for showing/hiding sections */
    .hidden {
      display: none !important;
      opacity: 0;
    }
    .visible {
      display: flex !important;
      opacity: 1;
    }

    /* Styles for the cropping modal */
    .crop-modal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 200; /* Higher than other modals */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8); /* Darker overlay */
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .crop-modal-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      text-align: center;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .crop-modal-content img {
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }

    .crop-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .crop-buttons button {
      background: linear-gradient(90deg, #8A2BE2, #4B0082);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .crop-buttons button:hover {
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.6);
      transform: translateY(-1px);
    }

    .crop-buttons button.cancel-crop {
      background: #FF7B54;
    }
    .crop-buttons button.cancel-crop:hover {
      box-shadow: 0 0 10px rgba(255, 123, 84, 0.6);
    }
  </style>
</head>
<body>
  <div class="auth-container" id="auth-container">
    <div class="auth-header">
      <div class="logo">VibeRoom</div> 
      <p id="auth-subtitle">Sign up to join the vibe!</p>
    </div>
    <form class="auth-form" id="auth-form">
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="e.g., @raghu_07">
      </div>
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" placeholder="Enter your name">
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Enter email">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter password">
      </div>
      <div class="form-group" id="dob-group">
        <label for="dob">Date of Birth</label>
        <input type="date" id="dob">
      </div>
      <div class="form-group" id="gender-group">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="">Select Gender</option>
        </select>
      </div>
      <div class="form-group" id="country-group">
        <label for="country">Country</label>
        <select id="country">
          <option value="">Select Country</option>
        </select>
      </div>
      <div class="form-group" id="language-group">
        <label for="language">Preferred Language</label>
        <select id="language">
          <option value="">Select Language</option>
        </select>
      </div>
      <button type="submit" class="auth-btn" id="auth-btn">Sign Up</button>
      <div class="error-message" id="error-message"></div>
    </form>
    <div class="social-login">
      <div class="social-btn" id="google-login">
        <i class="fab fa-google"></i>
      </div>
      <div class="social-btn" id="apple-login">
        <i class="fab fa-apple"></i>
      </div>
    </div>
    <div class="toggle-auth">
      Already have an account? <a href="#" id="toggle-link">Log In</a>
    </div>
  </div>

  <div class="profile-section hidden" id="profile-section">
    <header>
      <div class="logo">VibeRoom</div>
      <div class="header-actions">
        <div class="notification">
          <i class="fas fa-bell"></i>
        </div>
        <button class="logout-btn" id="logout-btn">Logout</button>
      </div>
    </header>
    
    <main>
      <div class="gradient-card">
        <div class="gradient-card-icon">
          <i class="fas fa-user"></i>
        </div>
        <div class="gradient-card-text">
          <h3>Your Profile</h3>
          <p>Manage your personal information</p>
        </div>
      </div>
      
      <section class="profile">
        <div class="section-heading">
          <i class="fas fa-user"></i> Profile
        </div>
        <div class="profile-card">
          <div class="profile-header">
            <div class="avatar">
              <img src="https://placehold.co/100x100/A239CA/FFFFFF?text=P" alt="Profile Picture" id="profile-img">
              <label for="profile-image-upload" class="avatar-upload-overlay">
                <i class="fas fa-camera"></i>
                <input type="file" id="profile-image-upload" accept="image/*">
              </label>
            </div>
            <div class="profile-info">
              <h2 id="profile-username">@Username</h2>
              <p id="profile-name">User Name</p>
              <p id="profile-email">No Email</p>
              <p id="profile-dob">No DOB</p>
              <p id="profile-gender">No Gender</p>
              <p id="profile-country">No Country</p>
              <p id="profile-language">No Language</p>
              <p id="profile-status">Offline</p>
            </div>
          </div>
          <div class="profile-form">
            <label for="profile-username-input">Username</label>
            <input type="text" id="profile-username-input" placeholder="Enter your username">
            <label for="profile-name-input">Name</label>
            <input type="text" id="profile-name-input" placeholder="Enter your name">
            <label for="profile-dob-input">Date of Birth</label>
            <input type="date" id="profile-dob-input">
            <label for="profile-gender-select">Gender</label>
            <select id="profile-gender-select">
              <option value="">Select Gender</option>
            </select>
            <label for="profile-country-select">Country</label>
            <select id="profile-country-select">
              <option value="">Select Country</option>
            </select>
            <label for="profile-language-select">Preferred Language</label>
            <select id="profile-language-select">
              <option value="">Select Language</option>
            </select>
            <button id="save-profile">Save Changes</button>
          </div>
        </div>
      </section>
    </main>
    
    <nav>
      <a href="#" class="nav-item" id="nav-home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="#" class="nav-item" id="nav-viberoom">
        <i class="fas fa-music"></i>
        <span>VibeRoom</span>
      </a>
      <a href="#" class="nav-item" id="nav-buddies">
        <i class="fas fa-user-group"></i>
        <span>Buddies</span>
      </a>
      <a href="#" class="nav-item active" id="nav-profile">
        <i class="fas fa-user"></i>
        <span>Profile</span>
      </a>
    </nav>
  </div>

  <div id="customAlertModal" class="custom-modal">
    <div class="custom-modal-content">
      <h3 id="modalMessage"></h3>
      <button id="modalCloseButton">OK</button>
    </div>
  </div>

  <div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
      <h3>Crop your profile picture</h3>
      <div>
        <img id="imageToCrop" src="" alt="Image to Crop">
      </div>
      <div class="crop-buttons">
        <button id="cropAndUploadButton">Crop & Upload</button>
        <button class="cancel-crop" id="cancelCropButton">Cancel</button>
      </div>
    </div>
  </div>

  <div id="loading-screen">
    <div class="loading-text">Vibing...</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      GoogleAuthProvider, 
      signInWithPopup,
      updateProfile,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC1Si1eckeNa-aF2RtQzIDckDhbvZlI66A",
      authDomain: "viberoom-3af1f.firebaseapp.com",
      projectId: "viberoom-3af1f",
      storageBucket: "viberoom-3af1f.firebasestorage.app",
      messagingSenderId: "84466588442",
      appId: "1:84466588442:web:b2100ca39f2b25dba36aa3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Get elements for login/signup
    const authContainer = document.getElementById('auth-container');
    const form = document.getElementById('auth-form');
    const authBtn = document.getElementById('auth-btn');
    const authSubtitle = document.getElementById('auth-subtitle');
    const toggleLink = document.getElementById('toggle-link');
    const dobGroup = document.getElementById('dob-group');
    const genderGroup = document.getElementById('gender-group');
    const countryGroup = document.getElementById('country-group');
    const languageGroup = document.getElementById('language-group');
    const errorMessage = document.getElementById('error-message');
    const loadingScreen = document.getElementById('loading-screen');
    let isSignup = true;

    // Get elements for profile
    const profileSection = document.getElementById('profile-section');
    const profileUsernameDisplay = document.getElementById('profile-username');
    const profileNameDisplay = document.getElementById('profile-name');
    const profileEmailDisplay = document.getElementById('profile-email');
    const profileDobDisplay = document.getElementById('profile-dob');
    const profileGenderDisplay = document.getElementById('profile-gender');
    const profileCountryDisplay = document.getElementById('profile-country');
    const profileLanguageDisplay = document.getElementById('profile-language');
    const profileStatusDisplay = document.getElementById('profile-status');
    const profileUsernameInput = document.getElementById('profile-username-input');
    const profileNameInput = document.getElementById('profile-name-input');
    const profileDobInput = document.getElementById('profile-dob-input');
    const profileGenderSelect = document.getElementById('profile-gender-select');
    const profileCountrySelect = document.getElementById('profile-country-select');
    const profileLanguageSelect = document.getElementById('profile-language-select');
    const saveProfileButton = document.getElementById('save-profile');
    const logoutButton = document.getElementById('logout-btn');
    const profileImg = document.getElementById('profile-img');
    const profileImageUpload = document.getElementById('profile-image-upload');

    // Custom Alert Modal elements
    const customAlertModal = document.getElementById('customAlertModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalCloseButton = document.getElementById('modalCloseButton');

    // New elements for cropping modal
    const cropModal = document.getElementById('cropModal');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropAndUploadButton = document.getElementById('cropAndUploadButton');
    const cancelCropButton = document.getElementById('cancelCropButton');
    let cropper; // Variable to hold the Cropper instance

    // ImgBB API Key
    const IMGBB_API_KEY = 'ed2da0de64a3e62a7c622a3edbae9419';

    // Data for dropdowns
    const genders = ['Male', 'Female', 'Other', 'Prefer not to say'];
    const countries = [
      "United States", "Canada", "United Kingdom", "Australia", "India", "Germany", "France", "Japan", "China", "Brazil",
      "Mexico", "South Africa", "Egypt", "Nigeria", "Argentina", "Spain", "Italy", "Netherlands", "Sweden", "Norway",
      "Denmark", "Finland", "Switzerland", "Austria", "Belgium", "Portugal", "Greece", "Ireland", "New Zealand",
      "Singapore", "South Korea", "Thailand", "Indonesia", "Malaysia", "Philippines", "Vietnam", "Saudi Arabia",
      "United Arab Emirates", "Turkey", "Russia", "Poland", "Ukraine", "Colombia", "Chile", "Peru", "Venezuela",
      "Pakistan", "Bangladesh", "Sri Lanka", "Kenya", "Morocco", "Algeria", "Ethiopia", "Ghana", "Uganda", "Tanzania"
    ];
    const languages = [
      "English", "Spanish", "French", "German", "Mandarin Chinese", "Hindi", "Bengali", "Portuguese", "Russian", "Japanese",
      "Korean", "Arabic", "Punjabi", "Urdu", "Telugu", "Tamil", "Marathi", "Vietnamese", "Italian", "Turkish",
      "Thai", "Gujarati", "Polish", "Ukrainian", "Romanian", "Dutch", "Swedish", "Greek", "Czech", "Norwegian",
      "Danish", "Finnish", "Hebrew", "Indonesian", "Malay", "Filipino", "Swahili", "Amharic", "Yoruba", "Igbo"
    ];

    /**
     * Populates a select element with options from an array.
     * @param {HTMLSelectElement} selectElement - The select element to populate.
     * @param {string[]} dataArray - An array of strings for the options.
     * @param {string} selectedValue - The value to mark as selected.
     */
    function populateSelect(selectElement, dataArray, selectedValue) {
      const initialOption = selectElement.querySelector('option[value=""]');
      selectElement.innerHTML = '';
      if (initialOption) {
        selectElement.appendChild(initialOption);
      } else {
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Select...";
        selectElement.appendChild(defaultOption);
      }

      dataArray.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        if (item === selectedValue) {
          option.selected = true;
        }
        selectElement.appendChild(option);
      });
    }

    // Populate dropdowns on initial load
    document.addEventListener('DOMContentLoaded', () => {
      populateSelect(document.getElementById('gender'), genders, '');
      populateSelect(document.getElementById('country'), countries, '');
      populateSelect(document.getElementById('language'), languages, '');
      populateSelect(profileGenderSelect, genders, '');
      populateSelect(profileCountrySelect, countries, '');
      populateSelect(profileLanguageSelect, languages, '');
    });

    /**
     * Displays a custom alert modal with a given message.
     * @param {string} message - The message to display in the modal.
     */
    function showCustomAlert(message) {
      modalMessage.textContent = message;
      customAlertModal.style.display = 'flex';
    }

    // Close button for custom alert modal
    modalCloseButton.addEventListener('click', () => {
      customAlertModal.style.display = 'none';
    });

    /**
     * Displays an error message below the form.
     * @param {string} message - The error message to display.
     */
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 3000);
    }

    /**
     * Toggles between signup and login forms.
     */
    function toggleAuthMode() {
      isSignup = !isSignup;
      authSubtitle.textContent = isSignup ? 'Sign up to join the vibe!' : 'Log in to your account';
      authBtn.textContent = isSignup ? 'Sign Up' : 'Log In';
      toggleLink.textContent = isSignup ? 'Log In' : 'Sign Up';
      
      dobGroup.classList.toggle('hidden-field', !isSignup);
      genderGroup.classList.toggle('hidden-field', !isSignup);
      countryGroup.classList.toggle('hidden-field', !isSignup);
      languageGroup.classList.toggle('hidden-field', !isSignup);
      document.getElementById('name').parentElement.classList.toggle('hidden-field', !isSignup);

      document.getElementById('username').value = '';
      document.getElementById('name').value = '';
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      document.getElementById('dob').value = '';
      document.getElementById('gender').value = '';
      document.getElementById('country').value = '';
      document.getElementById('language').value = '';

      errorMessage.style.display = 'none';
    }

    // Event listener for toggling between login/signup
    toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      toggleAuthMode();
    });

    // Initial state setup
    document.addEventListener('DOMContentLoaded', () => {
      if (!isSignup) {
        dobGroup.classList.add('hidden-field');
        genderGroup.classList.add('hidden-field');
        countryGroup.classList.add('hidden-field');
        languageGroup.classList.add('hidden-field');
        document.getElementById('name').parentElement.classList.add('hidden-field');
      }
    });

    /**
     * Shows the loading screen.
     */
    function showLoadingScreen() {
      loadingScreen.style.display = 'flex';
      loadingScreen.classList.remove('hidden');
    }

    /**
     * Hides the loading screen.
     */
    function hideLoadingScreen() {
      loadingScreen.classList.add('hidden');
      loadingScreen.addEventListener('animationend', () => {
        loadingScreen.style.display = 'none';
      }, { once: true });
    }

    /**
     * Handles form submission for both signup and login.
     */
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!email) {
        showError('Please enter your email.');
        return;
      }
      if (!password) {
        showError('Please enter your password.');
        return;
      }

      try {
        if (isSignup) {
          const dob = document.getElementById('dob').value;
          const gender = document.getElementById('gender').value;
          const country = document.getElementById('country').value;
          const language = document.getElementById('language').value;

          if (!username.startsWith('@') || username.length < 4) {
            showError('Username must start with @ and be at least 4 characters');
            return;
          }
          if (!name) {
            showError('Please enter your name.');
            return;
          }
          if (!dob) {
            showError('Please enter your date of birth.');
            return;
          }
          if (!gender) {
            showError('Please select your gender.');
            return;
          }
          if (!country) {
            showError('Please select your country.');
            return;
          }
          if (!language) {
            showError('Please select your preferred language.');
            return;
          }

          const dobDate = new Date(dob);
          const today = new Date();
          let age = today.getFullYear() - dobDate.getFullYear();
          const monthDiff = today.getMonth() - dobDate.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dobDate.getDate())) {
            age--;
          }
          if (age < 13) {
            showError('You must be at least 13 years old to sign up');
            return;
          }

          showLoadingScreen();
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          await updateProfile(user, { displayName: username });

          await setDoc(doc(db, 'users', user.uid), {
            username,
            name,
            email,
            dob,
            gender,
            country,
            language,
            status: 'Online',
            profileImage: '' // Initialize with empty string
          });

          setTimeout(() => {
            hideLoadingScreen();
            showCustomAlert('Signed up successfully!');
          }, 2000);
          
        } else {
          showLoadingScreen();
          await signInWithEmailAndPassword(auth, email, password);
          
          setTimeout(() => {
            hideLoadingScreen();
            showCustomAlert('Logged in successfully!');
          }, 2000);
        }
      } catch (error) {
        hideLoadingScreen();
        switch (error.code) {
          case 'auth/email-already-in-use':
            showError('Email already in use');
            break;
          case 'auth/invalid-email':
            showError('Invalid email format');
            break;
          case 'auth/weak-password':
            showError('Password must be at least 6 characters');
            break;
          case 'auth/user-not-found':
          case 'auth/wrong-password':
            showError('Invalid email or password');
            break;
          default:
            showError('An error occurred: ' + error.message);
        }
      }
    });

    // Google Login
    document.getElementById('google-login').addEventListener('click', async () => {
      try {
        showLoadingScreen();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        if (!userDoc.exists()) {
          const userData = {
            username: user.displayName || '@' + user.email.split('@')[0],
            name: user.displayName || 'User',
            email: user.email,
            dob: '',
            gender: 'Prefer not to say',
            country: 'United States',
            language: 'English',
            status: 'Online',
            profileImage: user.photoURL || '' // Use Google profile photo if available
          };
          await setDoc(userDocRef, userData);
        } else {
          // If user exists, update their profile image if it's a Google photo and not already set
          if (user.photoURL && !userDoc.data().profileImage) {
            await updateDoc(userDocRef, { profileImage: user.photoURL });
          }
        }

        setTimeout(() => {
          hideLoadingScreen();
          showCustomAlert('Logged in with Google successfully!');
        }, 2000);

      } catch (error) {
        hideLoadingScreen();
        showError('Google login failed: ' + error.message);
      }
    });

    // Apple Login (Not implemented)
    document.getElementById('apple-login').addEventListener('click', () => {
      showCustomAlert('Apple login not implemented yet');
    });

    // Logout
    logoutButton.addEventListener('click', async () => {
      try {
        showLoadingScreen();
        await signOut(auth);
        setTimeout(() => {
          hideLoadingScreen();
          showCustomAlert('Logged out successfully!');
        }, 1000);
      } catch (error) {
        hideLoadingScreen();
        showCustomAlert('Logout failed: ' + error.message);
      }
    });

    // Mousemove parallax effect for login container
    const throttle = (func, limit) => {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }

    const handleMouseMove = (e) => {
      const { clientX, clientY } = e;
      const rect = authContainer.getBoundingClientRect();
      const isMouseInsidePanel = 
        clientX >= rect.left &&
        clientX <= rect.right &&
        clientY >= rect.top &&
        clientY <= rect.bottom;

      if (isMouseInsidePanel) {
        authContainer.style.transform = 'rotateY(0deg) rotateX(0deg)';
      } else {
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const normalizedX = (clientX - (window.innerWidth / 2)) / (window.innerWidth / 2);
        const normalizedY = (clientY - (window.innerHeight / 2)) / (window.innerHeight / 2);
        const maxRotate = 15;
        const rotateY = normalizedX * maxRotate;
        const rotateX = normalizedY * -maxRotate;
        authContainer.style.transform = `rotateY(${rotateY}deg) rotateX(${rotateX}deg)`;
      }
    };

    document.addEventListener('mousemove', throttle(handleMouseMove, 16));
    document.addEventListener('mouseleave', () => {
      authContainer.style.transform = 'rotateY(0deg) rotateX(0deg)';
    });

    /**
     * Uploads an image to imgbb.com.
     * @param {File} imageFile - The image file to upload.
     * @returns {Promise<string|null>} - A promise that resolves with the image URL or null on failure.
     */
    async function uploadImageToImgBB(imageFile) {
      const formData = new FormData();
      formData.append('image', imageFile);

      try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (data.success) {
          return data.data.url;
        } else {
          console.error('ImgBB upload failed:', data.error.message);
          showCustomAlert('Image upload failed: ' + data.error.message);
          return null;
        }
      } catch (error) {
        console.error('Error uploading image to ImgBB:', error);
        showCustomAlert('Error uploading image: ' + error.message);
        return null;
      }
    }

    // Variable to store the selected image file (will be the cropped one)
    let selectedProfileImageFile = null;

    // Handle image file selection for preview and cropping
    profileImageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          // Show the cropping modal
          cropModal.style.display = 'flex';
          imageToCrop.src = event.target.result;

          // Destroy previous cropper instance if any
          if (cropper) {
            cropper.destroy();
          }

          // Initialize Cropper.js
          cropper = new Cropper(imageToCrop, {
            aspectRatio: 1, // Force square aspect ratio for profile pictures
            viewMode: 1, // Restrict the crop box to not exceed the canvas
            // Other options as needed
          });
        };
        reader.readAsDataURL(file);
      } else {
        // If no file selected, revert to default or current saved image
        const user = auth.currentUser;
        if (user) {
          loadProfile(user); // Reload profile to get current image
        } else {
          profileImg.src = "https://placehold.co/100x100/A239CA/FFFFFF?text=P";
        }
      }
    });

    // Handle Crop & Upload button click
    cropAndUploadButton.addEventListener('click', () => {
      if (cropper) {
        showLoadingScreen();
        cropper.getCroppedCanvas({
          width: 200, // Desired width for the cropped image
          height: 200, // Desired height
        }).toBlob(async (blob) => {
          if (blob) {
            // Convert blob to File object for uploadImageToImgBB
            const croppedFile = new File([blob], "profile_image.png", { type: "image/png" });
            selectedProfileImageFile = croppedFile; // Store the cropped file

            // Hide cropping modal
            cropModal.style.display = 'none';
            hideLoadingScreen(); // Hide loading screen initially, will show again on save
            profileImg.src = URL.createObjectURL(croppedFile); // Set preview image to cropped image

          } else {
            hideLoadingScreen();
            showCustomAlert('Failed to crop image.');
          }
        }, 'image/png'); // Specify image format
      }
    });

    // Handle Cancel Crop button click
    cancelCropButton.addEventListener('click', () => {
      cropModal.style.display = 'none';
      if (cropper) {
        cropper.destroy();
      }
      selectedProfileImageFile = null; // Clear the selected file
      profileImageUpload.value = ''; // Reset file input
      // Revert preview image to current user's profile image or placeholder
      const user = auth.currentUser;
      if (user) {
        loadProfile(user);
      } else {
        profileImg.src = "https://placehold.co/100x100/A239CA/FFFFFF?text=P";
      }
    });

    /**
     * Loads user profile data from Firestore and updates the UI.
     * @param {Object} user - The Firebase User object.
     */
    async function loadProfile(user) {
      if (!user) {
        document.body.classList.remove('profile-active');
        authContainer.classList.remove('hidden');
        authContainer.classList.add('visible');
        profileSection.classList.remove('visible');
        profileSection.classList.add('hidden');
        return;
      }

      const userDocRef = doc(db, 'users', user.uid);
      try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          const profile = docSnap.data();
          profileUsernameDisplay.textContent = profile.username || '@Username';
          profileNameDisplay.textContent = profile.name || 'User Name';
          profileEmailDisplay.textContent = profile.email || 'No Email';
          profileDobDisplay.textContent = profile.dob || 'No DOB';
          profileGenderDisplay.textContent = profile.gender || 'No Gender';
          profileCountryDisplay.textContent = profile.country || 'No Country';
          profileLanguageDisplay.textContent = profile.language || 'No Language';
          profileStatusDisplay.textContent = profile.status || 'Offline';
          profileImg.src = profile.profileImage || "https://placehold.co/100x100/A239CA/FFFFFF?text=P"; // Load profile image

          profileUsernameInput.value = profile.username || '';
          profileNameInput.value = profile.name || '';
          profileDobInput.value = profile.dob || '';
          populateSelect(profileGenderSelect, genders, profile.gender);
          populateSelect(profileCountrySelect, countries, profile.country);
          populateSelect(profileLanguageSelect, languages, profile.language);

          document.body.classList.add('profile-active');
          authContainer.classList.remove('visible');
          authContainer.classList.add('hidden');
          profileSection.classList.remove('hidden');
          profileSection.classList.add('visible');
        } else {
          // Default values if no profile document exists
          profileUsernameDisplay.textContent = user.displayName || '@' + user.email.split('@')[0];
          profileNameDisplay.textContent = user.displayName || 'User Name';
          profileEmailDisplay.textContent = user.email || 'No Email';
          profileDobDisplay.textContent = 'No DOB';
          profileGenderDisplay.textContent = 'No Gender';
          profileCountryDisplay.textContent = 'No Country';
          profileLanguageDisplay.textContent = 'No Language';
          profileStatusDisplay.textContent = 'Online';
          profileImg.src = user.photoURL || "https://placehold.co/100x100/A239CA/FFFFFF?text=P"; // Use Google photoURL or placeholder

          profileUsernameInput.value = user.displayName || '@' + user.email.split('@')[0];
          profileNameInput.value = user.displayName || '';
          profileDobInput.value = '';
          populateSelect(profileGenderSelect, genders, 'Prefer not to say');
          populateSelect(profileCountrySelect, countries, 'United States');
          populateSelect(profileLanguageSelect, languages, 'English');

          document.body.classList.add('profile-active');
          authContainer.classList.remove('visible');
          authContainer.classList.add('hidden');
          profileSection.classList.remove('hidden');
          profileSection.classList.add('visible');
        }
      } catch (error) {
        console.error('Error fetching profile:', error);
        showCustomAlert('Failed to load profile data.');
        document.body.classList.remove('profile-active');
        authContainer.classList.remove('hidden');
        authContainer.classList.add('visible');
        profileSection.classList.remove('visible');
        profileSection.classList.add('hidden');
      }
    }

    // Save Profile Changes
    saveProfileButton.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showCustomAlert('You must be logged in to update your profile.');
        return;
      }

      const username = profileUsernameInput.value.trim();
      const name = profileNameInput.value.trim();
      const dob = profileDobInput.value;
      const gender = profileGenderSelect.value;
      const country = profileCountrySelect.value;
      const language = profileLanguageSelect.value;
      let profileImageUrl = profileImg.src; // Start with current image source, which might be a blob URL temporarily

      if (!username.startsWith('@') || username.length < 4) {
        showCustomAlert('Username must start with @ and be at least 4 characters');
        return;
      }
      if (!name) {
        showCustomAlert('Please enter your name.');
        return;
      }
      if (!dob) {
        showCustomAlert('Please enter your date of birth.');
        return;
      }
      if (!gender) {
        showCustomAlert('Please select your gender.');
        return;
      }
      if (!country) {
        showCustomAlert('Please select your country.');
        return;
      }
      if (!language) {
        showCustomAlert('Please select your preferred language.');
        return;
      }

      const dobDate = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - dobDate.getFullYear();
      const monthDiff = today.getMonth() - dobDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dobDate.getDate())) {
        age--;
      }
      if (age < 13) {
        showCustomAlert('You must be at least 13 years old to update your profile.');
        return;
      }

      try {
        showLoadingScreen();

        // Upload the selectedProfileImageFile (which is now the cropped image)
        if (selectedProfileImageFile) {
          const uploadedUrl = await uploadImageToImgBB(selectedProfileImageFile);
          if (uploadedUrl) {
            profileImageUrl = uploadedUrl;
          } else {
            hideLoadingScreen();
            return; // If image upload fails, stop here
          }
        }

        await updateProfile(user, { displayName: username, photoURL: profileImageUrl });
        await updateDoc(doc(db, 'users', user.uid), {
          username,
          name,
          dob,
          gender,
          country,
          language,
          profileImage: profileImageUrl // Save the image URL
        });
        
        // Update displayed profile info
        profileUsernameDisplay.textContent = username;
        profileNameDisplay.textContent = name;
        profileDobDisplay.textContent = dob;
        profileGenderDisplay.textContent = gender;
        profileCountryDisplay.textContent = country;
        profileLanguageDisplay.textContent = language;
        profileImg.src = profileImageUrl; // Ensure the display image is the final URL

        // Clear the selected file after successful upload/save
        selectedProfileImageFile = null;
        profileImageUpload.value = ''; // Reset file input

        setTimeout(() => {
          hideLoadingScreen();
          showCustomAlert('Profile updated successfully!');
        }, 1000);
      } catch (error) {
        hideLoadingScreen();
        console.error('Error updating profile:', error);
        showCustomAlert('Failed to update profile: ' + error.message);
      }
    });

    // Navigation items
    const navItems = document.querySelectorAll('.profile-section .nav-item');
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
      });
    });

    // Firebase Auth State Listener
    onAuthStateChanged(auth, (user) => {
      loadProfile(user);
    });
  </script>
</body>
</html>
